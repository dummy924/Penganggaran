<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penganggaran Mobile-First v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto max-w-2xl p-4">
        <!-- Header -->
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-blue-600">AnggaranKu</h1>
            <p class="text-slate-500 mt-2">Catat dan kelola keuangan Anda dengan mudah.</p>
        </header>

        <!-- Saldo Utama -->
        <section class="bg-white p-6 rounded-2xl shadow-md mb-6">
            <h2 class="text-sm font-medium text-slate-500">Saldo Saat Ini</h2>
            <p id="currentBalance" class="text-4xl font-bold mt-1">Rp 0</p>
        </section>

        <!-- NEW: Dasbor Analitik -->
        <section class="mb-6">
            <h2 class="text-xl font-bold mb-4">Analisis Bulan Ini</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Rasio Tabungan -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-semibold text-slate-600">Rasio Tabungan</h3>
                    <p id="savingsRate" class="text-2xl font-bold text-indigo-600 mt-1">0%</p>
                </div>
                <!-- Wajib vs Keinginan -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-semibold text-slate-600">Pengeluaran</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                        <div id="needsWantsBar" class="bg-gradient-to-r from-sky-500 to-indigo-500 h-4 rounded-full" style="width: 0%;"></div>
                    </div>
                    <div class="text-xs flex justify-between mt-1">
                        <span id="needsPercentage" class="font-semibold text-sky-600">Wajib: 0%</span>
                        <span id="wantsPercentage" class="font-semibold text-indigo-600">Keinginan: 0%</span>
                    </div>
                </div>
                 <!-- Pie Chart -->
                <div class="bg-white p-4 rounded-xl shadow-sm sm:col-span-2">
                     <h3 class="font-semibold text-slate-600 mb-2">Komposisi Pengeluaran</h3>
                     <div class="h-56">
                        <canvas id="expensePieChart"></canvas>
                     </div>
                </div>
            </div>
        </section>

        <!-- Tombol Aksi Utama -->
        <section class="grid grid-cols-2 gap-4 mb-6">
            <button id="addTransactionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow transition-transform transform hover:scale-105">
                (+) Transaksi Baru
            </button>
            <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow transition-transform transform hover:scale-105">
                Export Excel
            </button>
        </section>

        <!-- Riwayat Transaksi -->
        <section>
            <h2 class="text-xl font-bold mb-4">Riwayat Transaksi</h2>
            <div id="transactionList" class="space-y-3">
                <p id="noTransactionsMessage" class="text-center text-slate-500 py-8">Belum ada transaksi.</p>
            </div>
        </section>
    </div>

    <!-- Modal Tambah/Edit Transaksi -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <h3 id="modalTitle" class="text-2xl font-bold mb-6">Tambah Transaksi</h3>
            <form id="transactionForm" class="space-y-4">
                <input type="hidden" id="transactionId">
                <div>
                    <label for="transactionType" class="block text-sm font-medium text-slate-600">Tipe</label>
                    <select id="transactionType" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>
                <div>
                    <label for="transactionDescription" class="block text-sm font-medium text-slate-600">Deskripsi</label>
                    <input type="text" id="transactionDescription" placeholder="misal: Belanja bulanan" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="transactionAmount" class="block text-sm font-medium text-slate-600">Jumlah</label>
                    <input type="number" id="transactionAmount" placeholder="0" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="transactionDate" class="block text-sm font-medium text-slate-600">Tanggal</label>
                    <input type="date" id="transactionDate" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- NEW: Kategori Wajib vs. Keinginan -->
                <div id="categoryContainer">
                    <label for="transactionCategory" class="block text-sm font-medium text-slate-600">Kategori</label>
                    <select id="transactionCategory" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="wajib">Wajib (Kebutuhan)</option>
                        <option value="keinginan">Keinginan (Gaya Hidup)</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancelBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-5 rounded-lg">Batal</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Message Box -->
    <div id="messageBox" class="fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-5 rounded-lg shadow-lg text-center opacity-0 transition-all duration-300 pointer-events-none" style="z-index: 100;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentBalanceEl = document.getElementById('currentBalance');
            const transactionListEl = document.getElementById('transactionList');
            const noTransactionsMessageEl = document.getElementById('noTransactionsMessage');
            
            // Modal Elements
            const transactionModal = document.getElementById('transactionModal');
            const modalTitleEl = document.getElementById('modalTitle');
            const transactionForm = document.getElementById('transactionForm');
            const transactionIdInput = document.getElementById('transactionId');
            const transactionTypeInput = document.getElementById('transactionType');
            const transactionDescriptionInput = document.getElementById('transactionDescription');
            const transactionAmountInput = document.getElementById('transactionAmount');
            const transactionDateInput = document.getElementById('transactionDate');
            const transactionCategoryInput = document.getElementById('transactionCategory'); // NEW
            const categoryContainer = document.getElementById('categoryContainer'); // NEW

            // Buttons
            const addTransactionBtn = document.getElementById('addTransactionBtn');
            const exportBtn = document.getElementById('exportBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            // Analytics UI
            const savingsRateEl = document.getElementById('savingsRate');
            const needsWantsBar = document.getElementById('needsWantsBar');
            const needsPercentageEl = document.getElementById('needsPercentage');
            const wantsPercentageEl = document.getElementById('wantsPercentage');

            // Message Box
            const messageBox = document.getElementById('messageBox');
            let expenseChart;

            let transactions = JSON.parse(localStorage.getItem('budget-transactions')) || [];

            const formatRupiah = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            const formatDate = (dateString) => new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            function showMessage(message, isSuccess = true) {
                messageBox.textContent = message;
                messageBox.classList.remove('opacity-0');
                messageBox.classList.toggle('bg-green-600', isSuccess);
                messageBox.classList.toggle('bg-red-600', !isSuccess);
                setTimeout(() => { messageBox.classList.add('opacity-0'); }, 3000);
            }

            function saveAndRender() {
                localStorage.setItem('budget-transactions', JSON.stringify(transactions));
                renderAnalytics();
                renderTransactions();
            }

            function renderAnalytics() {
                // Total Balance
                const balance = transactions.reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0);
                currentBalanceEl.textContent = formatRupiah(balance);

                // Monthly Analytics
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                const monthlyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate >= startOfMonth && tDate <= endOfMonth;
                });

                const monthlyIncome = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const monthlyExpense = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                // Savings Rate
                const savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpense) / monthlyIncome) * 100 : 0;
                savingsRateEl.textContent = `${Math.round(savingsRate)}%`;

                // Needs vs Wants
                const needsExpense = monthlyTransactions.filter(t => t.type === 'expense' && t.category === 'wajib').reduce((sum, t) => sum + t.amount, 0);
                const wantsExpense = monthlyTransactions.filter(t => t.type === 'expense' && t.category === 'keinginan').reduce((sum, t) => sum + t.amount, 0);
                const totalCategorizedExpense = needsExpense + wantsExpense;

                const needsPerc = totalCategorizedExpense > 0 ? (needsExpense / totalCategorizedExpense) * 100 : 0;
                needsWantsBar.style.width = `${needsPerc}%`;
                needsPercentageEl.textContent = `Wajib: ${Math.round(needsPerc)}%`;
                wantsPercentageEl.textContent = `Keinginan: ${Math.round(100 - needsPerc)}%`;
                
                renderPieChart(monthlyTransactions);
            }
            
            function renderPieChart(monthlyTransactions) {
                const ctx = document.getElementById('expensePieChart').getContext('2d');
                if(expenseChart) expenseChart.destroy();

                const expenseData = monthlyTransactions.filter(t => t.type === 'expense')
                    .reduce((acc, t) => {
                        acc[t.description] = (acc[t.description] || 0) + t.amount;
                        return acc;
                    }, {});

                const labels = Object.keys(expenseData);
                const data = Object.values(expenseData);
                
                if(labels.length === 0) return;

                expenseChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{ data: data, backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#ef4444', '#64748b'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            function renderTransactions() {
                transactionListEl.innerHTML = '';
                if (transactions.length === 0) {
                    noTransactionsMessageEl.style.display = 'block';
                    return;
                }
                noTransactionsMessageEl.style.display = 'none';

                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                transactions.forEach(t => {
                    const isIncome = t.type === 'income';
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-xl shadow-sm flex items-center justify-between';
                    item.innerHTML = `
                        <div>
                            <p class="font-bold">${t.description}</p>
                            <p class="text-sm text-slate-500">${formatDate(t.date)}</p>
                        </div>
                        <p class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">
                            ${isIncome ? '+' : '-'} ${formatRupiah(t.amount)}
                        </p>
                    `;
                    item.addEventListener('click', () => openModal(t.id));
                    transactionListEl.appendChild(item);
                });
            }

            function openModal(id = null) {
                transactionForm.reset();
                if (id) {
                    const t = transactions.find(t => t.id === id);
                    modalTitleEl.textContent = 'Edit Transaksi';
                    transactionIdInput.value = t.id;
                    transactionTypeInput.value = t.type;
                    transactionDescriptionInput.value = t.description;
                    transactionAmountInput.value = t.amount;
                    transactionDateInput.value = t.date;
                    transactionCategoryInput.value = t.category || 'wajib';
                } else {
                    modalTitleEl.textContent = 'Tambah Transaksi';
                    transactionIdInput.value = '';
                    transactionDateInput.value = new Date().toISOString().slice(0, 10);
                }
                toggleCategoryInput();
                transactionModal.classList.remove('hidden');
            }

            function closeModal() {
                transactionModal.classList.add('hidden');
            }
            
            function toggleCategoryInput() {
                categoryContainer.style.display = transactionTypeInput.value === 'expense' ? 'block' : 'none';
            }

            addTransactionBtn.addEventListener('click', () => openModal());
            cancelBtn.addEventListener('click', closeModal);
            transactionTypeInput.addEventListener('change', toggleCategoryInput);

            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = transactionIdInput.value;
                const newTransaction = {
                    id: id || `tx_${new Date().getTime()}`,
                    type: transactionTypeInput.value,
                    description: transactionDescriptionInput.value,
                    amount: parseFloat(transactionAmountInput.value),
                    date: transactionDateInput.value,
                    category: transactionTypeInput.value === 'expense' ? transactionCategoryInput.value : null
                };

                if (!newTransaction.description || isNaN(newTransaction.amount) || !newTransaction.date) {
                    showMessage('Harap isi semua kolom.', false);
                    return;
                }

                if (id) {
                    transactions = transactions.map(t => t.id === id ? newTransaction : t);
                } else {
                    transactions.push(newTransaction);
                }
                saveAndRender();
                closeModal();
            });

            exportBtn.addEventListener('click', () => {
                if (transactions.length === 0) {
                    showMessage('Tidak ada data untuk diekspor.', false);
                    return;
                }
                const dataToExport = transactions.map(t => ({
                    Tanggal: t.date,
                    Tipe: t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                    Deskripsi: t.description,
                    Jumlah: t.amount,
                    Kategori: t.category || ''
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Anggaran");
                XLSX.writeFile(workbook, "laporan_anggaran.xlsx");
            });

            saveAndRender();
        });
    </script>
</body>
</html>
