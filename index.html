<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Anggaran Cerdas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .auth-button-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Main Container -->
    <div id="app">

        <!-- Login Screen -->
        <div id="login-screen" class="flex items-center justify-center min-h-screen bg-slate-200">
            <div class="text-center p-8 bg-white rounded-2xl shadow-2xl max-w-sm mx-4">
                <h1 class="text-3xl font-bold text-slate-800 mb-2">Anggaran Cerdas</h1>
                <p class="text-slate-600 mb-8">Masuk untuk mengelola keuangan Anda dengan aman.</p>
                <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg flex items-center justify-center transition-transform transform hover:scale-105 active:scale-95">
                    <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_light_color_272x92dp.png" alt="Logo Google" class="auth-button-icon bg-white p-1 rounded-full">
                    Masuk dengan Google
                </button>
            </div>
        </div>

        <!-- App Container (Hidden by default) -->
        <div id="app-container" class="hidden">
            <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                
                <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div>
                        <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Dasbor Anggaran</h1>
                        <p id="userDisplay" class="text-sm text-slate-500 mt-1"></p>
                    </div>
                    <button id="logoutButton" class="mt-4 sm:mt-0 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm transition">
                        Keluar
                    </button>
                </header>

                <!-- Dashboard Analytics Section -->
                <section id="dashboard" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Main Balance Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 col-span-1 lg:col-span-2">
                        <h2 class="text-lg font-semibold text-slate-600 mb-2">Total Saldo Saat Ini</h2>
                        <p id="currentBalance" class="text-4xl sm:text-5xl font-bold text-blue-600">Rp 0</p>
                    </div>
                    
                    <!-- Monthly Analysis Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                        <h3 class="text-md font-semibold text-slate-600 mb-4">Analisis Bulan Ini</h3>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-slate-500">Total Pemasukan</p>
                                <p id="monthlyIncome" class="text-2xl font-bold text-green-600">Rp 0</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Total Pengeluaran</p>
                                <p id="monthlyExpense" class="text-2xl font-bold text-red-600">Rp 0</p>
                            </div>
                             <div>
                                <p class="text-sm text-slate-500">Rasio Tabungan (Savings Rate)</p>
                                <p id="savingsRate" class="text-2xl font-bold text-indigo-600">0%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Expense Chart -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                        <h3 class="text-md font-semibold text-slate-600 mb-4">Komposisi Pengeluaran Bulan Ini</h3>
                        <div class="chart-container">
                            <canvas id="expensePieChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Transaction Management Section -->
                <section id="transaction-management" class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2 sm:mb-0">Histori Transaksi</h2>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <button id="exportBudgetButton" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 active:scale-95 text-sm">
                                Export ke Excel
                            </button>
                            <button id="addIncomeButton" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 active:scale-95 text-sm">
                                + Pemasukan
                            </button>
                            <button id="addExpenseButton" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 active:scale-95 text-sm">
                                - Pengeluaran
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="transactionSearchInput" placeholder="Cari berdasarkan deskripsi, jenis, jumlah, atau tanggal..." class="w-full p-3 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transactionList" class="bg-white divide-y divide-gray-200">
                                <!-- Items will be rendered here -->
                            </tbody>
                        </table>
                        <p id="noTransactionsMessage" class="text-gray-500 text-center mt-8 hidden">Belum ada transaksi. Silakan tambahkan satu!</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Transaction Modal -->
    <div id="addEditTransactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 id="transactionModalTitle" class="text-2xl font-bold text-gray-800 mb-6">Tambah Transaksi</h3>
            <div class="space-y-4">
                <div id="transactionTypeContainer">
                    <select id="transactionTypeInput" class="w-full p-3 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500">
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>
                <input type="number" id="transactionAmountInput" placeholder="Jumlah (Rp)" class="w-full p-3 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500" min="0">
                <input type="text" id="transactionDescriptionInput" placeholder="Deskripsi (misal: Gaji, Belanja Makanan)" class="w-full p-3 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500">
                <input type="date" id="transactionDateInput" class="w-full p-3 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancelTransactionButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">Batal</button>
                <button id="confirmTransactionButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">Simpan</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="exportBudgetModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Pilih Rentang Tanggal Ekspor</h3>
            <div class="space-y-4">
                <div>
                    <label for="exportStartDateInput" class="block text-sm font-medium text-gray-700">Tanggal Mulai:</label>
                    <input type="date" id="exportStartDateInput" class="w-full p-3 border border-gray-300 rounded-lg text-gray-700 mt-1">
                </div>
                <div>
                    <label for="exportEndDateInput" class="block text-sm font-medium text-gray-700">Tanggal Akhir:</label>
                    <input type="date" id="exportEndDateInput" class="w-full p-3 border border-gray-300 rounded-lg text-gray-700 mt-1">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancelExportButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">Batal</button>
                <button id="confirmExportButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Ekspor</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4 text-center">
            <h3 id="confirmationTitle" class="text-xl font-bold text-gray-800 mb-4">Konfirmasi Hapus</h3>
            <p id="confirmationMessage" class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus transaksi ini?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelConfirmationButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg">Batal</button>
                <button id="confirmDeleteButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg">Hapus</button>
            </div>
        </div>
    </div>
    
    <!-- Message Box -->
    <div id="messageBox" class="fixed bottom-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-lg text-center opacity-0 transition-all duration-300 pointer-events-none" style="z-index: 1000;"></div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // TODO: GANTI DENGAN KONFIGURASI FIREBASE ANDA
        // Anda bisa mendapatkan ini dari Pengaturan Proyek (Project Settings) di konsol Firebase Anda.
        const firebaseConfig = {
          apiKey: "AIzaSyDVCidRfGUmrwQBppz2-88bPxnUHZ1C2RQ",
          authDomain: "penganggaran-31558.firebaseapp.com",
          projectId: "penganggaran-31558",
          storageBucket: "penganggaran-31558.firebasestorage.app",
          messagingSenderId: "290871974444",
          appId: "1:290871974444:web:021b9c3832e4bbf22ecf89"
        };
        
        // --- Firebase Initialization ---
        let app, auth, db;
        let appId = 'smart-budget-app'; // Anda bisa mengganti ini jika perlu
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            if (e.message.includes("Cannot read properties of undefined")) {
                 showMessage("Konfigurasi Firebase belum diisi. Harap edit kode dan masukkan konfigurasi Anda.", "error");
            } else {
                 showMessage("Gagal terhubung ke server. Coba muat ulang halaman.", "error");
            }
        }

        // --- Global State ---
        let budgetTransactions = [];
        let editingTransactionId = null;
        let expenseChart = null;
        let currentUserId = null;
        let transactionsUnsubscribe = null;

        // --- DOM Element References ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const userDisplay = document.getElementById('userDisplay');
        const currentBalance = document.getElementById('currentBalance');
        const monthlyIncome = document.getElementById('monthlyIncome');
        const monthlyExpense = document.getElementById('monthlyExpense');
        const savingsRate = document.getElementById('savingsRate');
        const transactionList = document.getElementById('transactionList');
        const noTransactionsMessage = document.getElementById('noTransactionsMessage');
        const transactionSearchInput = document.getElementById('transactionSearchInput');
        
        // Modal & Controls
        const addIncomeButton = document.getElementById('addIncomeButton');
        const addExpenseButton = document.getElementById('addExpenseButton');
        const addEditTransactionModal = document.getElementById('addEditTransactionModal');
        const transactionModalTitle = document.getElementById('transactionModalTitle');
        const transactionTypeContainer = document.getElementById('transactionTypeContainer');
        const transactionTypeInput = document.getElementById('transactionTypeInput');
        const transactionAmountInput = document.getElementById('transactionAmountInput');
        const transactionDescriptionInput = document.getElementById('transactionDescriptionInput');
        const transactionDateInput = document.getElementById('transactionDateInput');
        const cancelTransactionButton = document.getElementById('cancelTransactionButton');
        const confirmTransactionButton = document.getElementById('confirmTransactionButton');
        const exportBudgetButton = document.getElementById('exportBudgetButton');
        const exportBudgetModal = document.getElementById('exportBudgetModal');
        const exportStartDateInput = document.getElementById('exportStartDateInput');
        const exportEndDateInput = document.getElementById('exportEndDateInput');
        const cancelExportButton = document.getElementById('cancelExportButton');
        const confirmExportButton = document.getElementById('confirmExportButton');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const cancelConfirmationButton = document.getElementById('cancelConfirmationButton');
        let confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const messageBox = document.getElementById('messageBox');

        // --- Utility Functions ---
        const showMessage = (message, type = 'error') => {
            messageBox.textContent = message;
            messageBox.className = 'fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg text-center transition-all duration-300 pointer-events-none';
            messageBox.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
            messageBox.classList.remove('opacity-0');
            setTimeout(() => messageBox.classList.add('opacity-0'), 4000);
        };
        const formatRupiah = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const formatDateToYYYYMMDD = (dateObj) => dateObj.toISOString().split('T')[0];
        const capitalizeWords = (str) => {
            if (!str) return '';
            return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        };

        // --- Authentication ---
        const loginWithGoogle = async () => {
            if (!auth) {
                showMessage("Konfigurasi Firebase belum lengkap.", "error");
                return;
            }
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showMessage("Gagal masuk dengan Google. Coba lagi.", "error");
            }
        };

        const logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign-Out Error:", error);
                showMessage("Gagal keluar. Coba lagi.", "error");
            }
        };

        if (auth) {
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUserId = user.uid;
                    userDisplay.textContent = `Masuk sebagai: ${user.displayName || user.email}`;
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    loadAndListenTransactions(currentUserId);
                } else {
                    currentUserId = null;
                    if (transactionsUnsubscribe) {
                        transactionsUnsubscribe();
                        transactionsUnsubscribe = null;
                    }
                    budgetTransactions = [];
                    renderUI();
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });
        }

        // --- Firestore Data Handling ---
        const loadAndListenTransactions = (userId) => {
            if (!userId || !db) return;
            const transactionsRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            const q = query(transactionsRef);

            if (transactionsUnsubscribe) {
                transactionsUnsubscribe();
            }

            transactionsUnsubscribe = onSnapshot(q, (snapshot) => {
                budgetTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            }, (error) => {
                console.error("Error listening to transactions:", error);
                showMessage("Gagal memuat data. Periksa koneksi Anda.", "error");
            });
        };

        // --- Core UI Rendering & Calculation ---
        function renderUI() {
            renderDashboard();
            renderTransactionList();
        }

        function renderDashboard() {
            const totalBalance = budgetTransactions.reduce((total, t) => t.type === 'income' ? total + t.amount : total - t.amount, 0);
            currentBalance.textContent = formatRupiah(totalBalance);

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const monthlyTransactions = budgetTransactions.filter(t => {
                if (!t.date) return false;
                const tDate = new Date(t.date);
                return tDate >= startOfMonth && tDate <= endOfMonth;
            });

            const incomeThisMonth = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenseThisMonth = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            monthlyIncome.textContent = formatRupiah(incomeThisMonth);
            monthlyExpense.textContent = formatRupiah(expenseThisMonth);

            const rate = incomeThisMonth > 0 ? ((incomeThisMonth - expenseThisMonth) / incomeThisMonth) * 100 : 0;
            savingsRate.textContent = `${Math.round(rate)}%`;

            renderExpensePieChart(monthlyTransactions);
        }

        function renderExpensePieChart(transactions) {
            const ctx = document.getElementById('expensePieChart').getContext('2d');
            const expenseData = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    const desc = t.description.toLowerCase();
                    acc[desc] = (acc[desc] || 0) + t.amount;
                    return acc;
                }, {});

            const labels = Object.keys(expenseData);
            const data = Object.values(expenseData);
            const backgroundColors = labels.map((_, i) => `hsl(${i * 40 + 200}, 70%, 60%)`);

            if (expenseChart) expenseChart.destroy();
            
            if (labels.length === 0) {
                 return;
            }
            
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        label: 'Pengeluaran',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 10 } } },
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${formatRupiah(c.parsed)}` } }
                    }
                }
            });
        }
        
        function renderTransactionList() {
            transactionList.innerHTML = '';
            const searchTerm = transactionSearchInput.value.toLowerCase();
            const filtered = budgetTransactions
                .filter(t => {
                    if (!searchTerm) return true;

                    // Terjemahkan tipe transaksi ke Bahasa Indonesia untuk pencarian
                    const translatedType = t.type === 'income' ? 'pemasukan' : 'pengeluaran';

                    const formattedDate = new Date(t.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }).toLowerCase();
                    return (
                        t.description.toLowerCase().includes(searchTerm) ||
                        t.type.toLowerCase().includes(searchTerm) || // Pencarian asli (income/expense)
                        translatedType.includes(searchTerm) ||       // Pencarian terjemahan (pemasukan/pengeluaran)
                        t.amount.toString().includes(searchTerm) ||
                        formattedDate.includes(searchTerm) ||
                        t.date.includes(searchTerm)
                    );
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            noTransactionsMessage.classList.toggle('hidden', filtered.length > 0);
            filtered.forEach(t => transactionList.appendChild(createTransactionElement(t)));
        }
        
        function createTransactionElement(transaction) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            const typeClass = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
            const sign = transaction.type === 'income' ? '+' : '-';

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${transaction.description}</div>
                    <div class="text-sm text-gray-500">${new Date(transaction.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric'})}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${typeClass}">
                    ${sign} ${formatRupiah(transaction.amount)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                    <button class="delete-btn text-red-600 hover:text-red-900">Hapus</button>
                </td>
            `;

            tr.querySelector('.edit-btn').addEventListener('click', () => showAddEditTransactionModal(transaction.id));
            tr.querySelector('.delete-btn').addEventListener('click', () => showConfirmationModal(transaction));
            return tr;
        }

        // --- Transaction Logic ---
        async function saveTransaction() {
            if (!currentUserId) {
                showMessage("Anda harus masuk untuk menyimpan transaksi.", "error");
                return;
            }

            const type = transactionTypeInput.value;
            const amount = parseFloat(transactionAmountInput.value);
            const description = capitalizeWords(transactionDescriptionInput.value.trim());
            const date = transactionDateInput.value;

            if (isNaN(amount) || amount <= 0 || !description || !date) {
                showMessage('Harap isi semua kolom dengan benar.', 'error');
                return;
            }

            const transactionData = { type, amount, description, date };
            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'transactions');

            try {
                if (editingTransactionId) {
                    const docRef = doc(collectionRef, editingTransactionId);
                    await updateDoc(docRef, transactionData);
                    showMessage('Transaksi berhasil diperbarui.', 'success');
                } else {
                    await addDoc(collectionRef, transactionData);
                    showMessage('Transaksi berhasil ditambahkan.', 'success');
                }
                hideAddEditTransactionModal();
            } catch (error) {
                console.error("Error saving transaction:", error);
                showMessage("Gagal menyimpan transaksi. Coba lagi.", "error");
            }
        }
        
        async function deleteTransaction(id) {
            if (!currentUserId || !id) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'transactions', id);
            try {
                await deleteDoc(docRef);
                showMessage('Transaksi berhasil dihapus.', 'success');
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showMessage("Gagal menghapus transaksi. Coba lagi.", "error");
            }
        }

        // --- Modal Handling ---
        function showAddEditTransactionModal(id = null, type = 'expense') {
            editingTransactionId = id;
            if (id) {
                const t = budgetTransactions.find(t => t.id === id);
                transactionModalTitle.textContent = 'Edit Transaksi';
                transactionTypeContainer.style.display = 'block';
                transactionTypeInput.disabled = false;
                transactionTypeInput.value = t.type;
                transactionAmountInput.value = t.amount;
                transactionDescriptionInput.value = t.description;
                transactionDateInput.value = t.date;
            } else {
                transactionModalTitle.textContent = type === 'income' ? 'Tambah Pemasukan' : 'Tambah Pengeluaran';
                transactionTypeContainer.style.display = 'none';
                transactionTypeInput.disabled = true;
                transactionTypeInput.value = type;
                transactionAmountInput.value = '';
                transactionDescriptionInput.value = '';
                transactionDateInput.value = formatDateToYYYYMMDD(new Date());
            }
            addEditTransactionModal.classList.remove('hidden');
            transactionAmountInput.focus();
        }

        function hideAddEditTransactionModal() {
            addEditTransactionModal.classList.add('hidden');
        }

        function showConfirmationModal(transaction) {
            confirmationMessage.textContent = `Apakah Anda yakin ingin menghapus transaksi "${transaction.description}"?`;
            confirmationModal.classList.remove('hidden');
            
            const newConfirmButton = confirmDeleteButton.cloneNode(true);
            confirmDeleteButton.parentNode.replaceChild(newConfirmButton, confirmDeleteButton);
            confirmDeleteButton = newConfirmButton;
            
            confirmDeleteButton.addEventListener('click', () => {
                deleteTransaction(transaction.id);
                hideConfirmationModal();
            }, { once: true });
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
        }

        // --- Export to Excel ---
        function showExportBudgetModal() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            exportStartDateInput.value = formatDateToYYYYMMDD(firstDay);
            exportEndDateInput.value = formatDateToYYYYMMDD(lastDay);
            exportBudgetModal.classList.remove('hidden');
        }

        function hideExportBudgetModal() {
            exportBudgetModal.classList.add('hidden');
        }
        
        function exportToXlsx() {
            const startDateString = exportStartDateInput.value;
            const endDateString = exportEndDateInput.value;

            if (!startDateString || !endDateString) {
                showMessage('Harap pilih tanggal mulai dan tanggal akhir.', 'error');
                return;
            }
            const startDate = new Date(startDateString);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateString);
            endDate.setHours(23, 59, 59, 999);

            if (startDate > endDate) {
                showMessage('Tanggal mulai tidak boleh setelah tanggal akhir.', 'error');
                return;
            }

            const groupTransactions = (transactions) => {
                const grouped = transactions.reduce((acc, t) => {
                    const desc = t.description.trim();
                    if (!acc[desc]) {
                        acc[desc] = { totalAmount: 0, count: 0 };
                    }
                    acc[desc].totalAmount += t.amount;
                    acc[desc].count += 1;
                    return acc;
                }, {});

                return Object.entries(grouped).map(([description, data]) => ({
                    description: data.count > 1 ? `${description} (${data.count}x)` : description,
                    amount: data.totalAmount
                }));
            };

            const transactionsBefore = budgetTransactions.filter(t => new Date(t.date) < startDate);
            const startingBalance = transactionsBefore.reduce((total, t) => t.type === 'income' ? total + t.amount : total - t.amount, 0);

            const filteredTransactions = budgetTransactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });

            if (filteredTransactions.length === 0) {
                showMessage('Tidak ada transaksi dalam rentang tanggal yang dipilih.', 'error');
                return;
            }

            const incomeTransactions = filteredTransactions.filter(t => t.type === 'income');
            const expenseTransactions = filteredTransactions.filter(t => t.type === 'expense');

            const groupedIncome = groupTransactions(incomeTransactions);
            const groupedExpense = groupTransactions(expenseTransactions);

            const totalIncome = incomeTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = expenseTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            const endingBalance = startingBalance + totalIncome - totalExpense;
            const netFlow = totalIncome - totalExpense;
            const savingsRateValue = totalIncome > 0 ? (netFlow / totalIncome) : 0;

            const ws_data = [];
            const readableEndDate = new Date(endDateString).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            ws_data.push(["Laporan Penganggaran"]);
            ws_data.push([`PER ${readableEndDate}`]);
            ws_data.push([]);

            ws_data.push(["Saldo Awal :", null, startingBalance]);
            ws_data.push([]);

            ws_data.push(["Pemasukan"]);
            groupedIncome.forEach(t => {
                ws_data.push([`  ${t.description}`, null, t.amount]);
            });
            ws_data.push(["Total Pemasukan", null, totalIncome]);
            ws_data.push([]);

            ws_data.push(["Pengeluaran"]);
            groupedExpense.forEach(t => {
                ws_data.push([`  ${t.description}`, null, t.amount]);
            });
            ws_data.push(["Total Pengeluaran", null, totalExpense]);
            ws_data.push([]);

            ws_data.push(["Saldo Akhir :", null, endingBalance]);
            ws_data.push([]);

            ws_data.push(["Ringkasan Analisis"]);
            ws_data.push(["Surplus / Defisit", null, netFlow]);
            ws_data.push(["Rasio Tabungan", null, savingsRateValue]);

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            const boldStyle = { font: { bold: true } };
            const titleStyle = { font: { bold: true, sz: 14 } };
            const currencyFormat = '"Rp"#,##0;[Red]"Rp"-#,##0';
            const percentageFormat = '0.0%';

            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }];
            if(ws['A1']) ws['A1'].s = titleStyle;
            ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 2 } });
            
            let currentRow = 3;
            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            if(ws[`C${currentRow + 1}`]) ws[`C${currentRow + 1}`].s = { ...boldStyle, numFmt: currencyFormat };
            currentRow += 2;

            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            currentRow++;
            groupedIncome.forEach(() => {
                const cellAddress = `C${currentRow + 1}`;
                if (ws[cellAddress]) { ws[cellAddress].z = currencyFormat; }
                currentRow++;
            });
            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            if(ws[`C${currentRow + 1}`]) ws[`C${currentRow + 1}`].s = { ...boldStyle, numFmt: currencyFormat };
            currentRow += 2;

            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            currentRow++;
            groupedExpense.forEach(() => {
                const cellAddress = `C${currentRow + 1}`;
                if (ws[cellAddress]) { ws[cellAddress].z = currencyFormat; }
                currentRow++;
            });
            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            if(ws[`C${currentRow + 1}`]) ws[`C${currentRow + 1}`].s = { ...boldStyle, numFmt: currencyFormat };
            currentRow += 2;
            
            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            if(ws[`C${currentRow + 1}`]) ws[`C${currentRow + 1}`].s = { ...boldStyle, numFmt: currencyFormat };
            currentRow += 2;

            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            currentRow++;
            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            if(ws[`C${currentRow + 1}`]) ws[`C${currentRow + 1}`].s = { ...boldStyle, numFmt: currencyFormat };
            currentRow++;
            if(ws[`A${currentRow + 1}`]) ws[`A${currentRow + 1}`].s = boldStyle;
            if(ws[`C${currentRow + 1}`]) ws[`C${currentRow + 1}`].s = { ...boldStyle, numFmt: percentageFormat };

            ws['!cols'] = [ { wch: 35 }, { wch: 10 }, { wch: 20 } ];

            XLSX.utils.book_append_sheet(wb, ws, "Laporan Penganggaran");
            const fileName = `Laporan_Penganggaran_PER_${endDateString}.xlsx`;
            XLSX.writeFile(wb, fileName);

            hideExportBudgetModal();
            showMessage('Laporan Excel berhasil dibuat!', 'success');
        }

        // --- Event Listeners ---
        loginButton.addEventListener('click', loginWithGoogle);
        logoutButton.addEventListener('click', logout);
        addIncomeButton.addEventListener('click', () => showAddEditTransactionModal(null, 'income'));
        addExpenseButton.addEventListener('click', () => showAddEditTransactionModal(null, 'expense'));
        cancelTransactionButton.addEventListener('click', hideAddEditTransactionModal);
        confirmTransactionButton.addEventListener('click', saveTransaction);
        transactionSearchInput.addEventListener('input', renderTransactionList);
        exportBudgetButton.addEventListener('click', showExportBudgetModal);
        cancelExportButton.addEventListener('click', hideExportBudgetModal);
        confirmExportButton.addEventListener('click', exportToXlsx);
        cancelConfirmationButton.addEventListener('click', hideConfirmationModal);

    </script>
</body>
</html>
