<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Quest: Gamified Budgeting App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.395.0/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* bg-slate-900 */
            color: #F8FAFC; /* text-slate-50 */
        }
        .input-field {
            width: 100%;
            background-color: #1E293B; /* bg-slate-800 */
            border: 1px solid #334155; /* border-slate-700 */
            color: #F1F5F9; /* text-slate-100 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #F59E0B; /* border-amber-500 */
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
        }
        .input-field::placeholder {
            color: #64748B; /* text-slate-500 */
        }
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #D97706; /* bg-amber-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #B45309; /* bg-amber-700 */
        }
        .btn-secondary {
             background-color: #2563EB; /* bg-blue-600 */
             color: white;
        }
        .btn-secondary:hover {
            background-color: #1D4ED8; /* bg-blue-700 */
        }
        .btn-danger {
            background-color: #DC2626; /* bg-red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #B91C1C; /* bg-red-700 */
        }
        .btn-google {
            background-color: #FFFFFF;
            color: #1F2937;
            border: 1px solid #D1D5DB;
        }
        .btn-google:hover {
            background-color: #F9FAFB;
        }
        .icon {
            width: 18px;
            height: 18px;
            stroke-width: 2.5px;
        }
        .btn .icon {
            font-size: 20px;
            line-height: 1;
        }
        #loading-spinner, #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #0F172A;
            z-index: 9999;
        }
        .chart-container {
            height: 250px;
        }
        .action-icon {
            cursor: pointer;
            color: #94a3b8; /* text-slate-400 */
            transition: color 0.2s;
            font-size: 22px;
        }
        .action-icon:hover {
            color: #f1f5f9; /* text-slate-100 */
        }
        .custom-checkbox {
            background-color: #1E293B;
            border-color: #334155;
            vertical-align: middle; 
        }
        .custom-checkbox:checked {
            background-color: #F59E0B;
            border-color: #F59E0B;
        }
        .quest-category-header {
            cursor: pointer;
            user-select: none;
        }
        .quest-category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .inventory-card {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            aspect-ratio: 3 / 4;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .inventory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .inventory-card .card-icon .material-symbols-outlined {
            font-size: 3.5rem;
            font-variation-settings: 'FILL' 1;
        }
        .inventory-card .card-name {
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            line-height: 1rem;
            color: #cbd5e1;
        }
        .inventory-card .card-footer {
            height: 0.375rem;
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        .inventory-card .card-count {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #f59e0b;
            color: #1e293b;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 9999px;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .xp-boost-indicator {
            display: none;
            background-color: #a855f7;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 9999px;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse { 50% { opacity: .5; } }
        .info-modal-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
        .info-modal-content h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f59e0b;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .info-modal-content p, .info-modal-content li { color: #cbd5e1; }
        .info-modal-content ul { list-style-position: inside; padding-left: 0.5rem; }
        .info-modal-content strong { color: #f1f5f9; }
        .dashboard-value { 
            display: inline-block;
            line-height: 1.2;
        }
        
        .challenge-flag.active { color: #EF4444; } /* text-red-500 */
        #offline-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #F59E0B; /* bg-amber-500 */
            color: #1E293B; /* text-slate-800 */
            text-align: center;
            padding: 0.5rem;
            font-weight: 600;
            z-index: 10000;
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="offline-indicator">
        Anda sedang offline. Perubahan akan disinkronkan saat kembali online.
    </div>

    <div id="loading-spinner">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-amber-500"></div>
    </div>

    <div id="login-screen" style="display: none;">
        <div class="text-center">
            <h1 class="text-4xl font-extrabold text-amber-400 tracking-tight flex items-center justify-center gap-3">
                <i data-lucide="gamepad-2"></i> Budget Quest
            </h1>
            <p class="text-slate-400 mt-2 mb-8">Masuk untuk memulai petualangan anggaranmu!</p>
            <button id="google-signin-btn" class="btn btn-google max-w-xs mx-auto w-full">
                <svg class="w-5 h-5 mr-2" role="img" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><g><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></g></svg>
                Masuk dengan Google
            </button>
        </div>
    </div>

    <main id="app-content" class="max-w-7xl mx-auto" style="display: none;">
        <header class="mb-8 flex justify-between items-center">
             <div id="user-profile-display" class="flex items-center gap-3"></div>
             <div class="flex items-center gap-4">
                <button id="inventory-btn" class="text-slate-400 hover:text-white transition-colors relative" aria-label="Buka Inventaris">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7"><path d="M4 20V10a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v10a2 2 0 0 1-2-2H6a2 2 0 0 1-2-2Z"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                    <span id="inventory-count" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center"></span>
                </button>
                <button id="signout-btn" class="btn bg-red-600 hover:bg-red-700 text-sm p-2 sm:py-2 sm:px-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span class="hidden sm:inline">Keluar</span>
                </button>
             </div>
        </header>

        <div id="error-display" class="bg-red-500/20 text-red-300 p-3 rounded-lg mb-6 text-center hidden"></div>
        
        <!-- PERBAIKAN: Section untuk notifikasi pintar -->
        <div id="smart-reminder-section" class="mb-8 space-y-4"></div>

        <div class="mb-8">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-3xl font-bold text-slate-200">Dasbor</h2>
                    <button id="dashboard-guide-btn" class="text-slate-400 hover:text-white transition-colors" aria-label="Buka Panduan Dasbor">
                        <span class="material-symbols-outlined">help_outline</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="today-btn" class="p-2 bg-slate-800 rounded-md hover:bg-slate-700 transition-colors" aria-label="Pindah ke Bulan Ini">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m16 20 2 2 4-4"/></svg>
                    </button>
                    <button id="prev-month-btn" class="p-2 bg-slate-800 rounded-md hover:bg-slate-700 transition-colors" aria-label="Bulan Sebelumnya">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <span id="current-month-display" class="font-semibold text-lg w-40 text-center"></span>
                    <button id="next-month-btn" class="p-2 bg-slate-800 rounded-md hover:bg-slate-700 transition-colors" aria-label="Bulan Berikutnya">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6">
                <div class="bg-slate-800 p-5 rounded-2xl shadow-lg">
                    <h3 class="text-sm font-medium text-slate-400 mb-1">Pemasukan Bulan Ini</h3>
                    <p id="total-income" class="font-bold text-green-400 dashboard-value">Rp 0</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl shadow-lg">
                    <h3 class="text-sm font-medium text-slate-400 mb-1">Pengeluaran Bulan Ini</h3>
                    <p id="total-expenses" class="font-bold text-red-400 dashboard-value">Rp 0</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl shadow-lg">
                    <h3 class="text-sm font-medium text-slate-400 mb-1">Arus Kas Bulan Ini</h3>
                    <p id="balance" class="font-bold text-blue-400 dashboard-value">Rp 0</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl shadow-lg">
                    <h3 class="text-sm font-medium text-slate-400 mb-1">Saving Rate</h3>
                    <p id="saving-rate" class="text-2xl md:text-3xl font-bold text-teal-400">0%</p>
                </div>
                 <div class="bg-slate-800 p-5 rounded-2xl shadow-lg">
                    <h3 class="text-sm font-medium text-slate-400 mb-1">Nilai Investasi</h3>
                    <p id="investment-value" class="font-bold text-indigo-400 dashboard-value">Rp 0</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl shadow-lg">
                    <h3 class="text-sm font-medium text-slate-400 mb-1">Total Kekayaan</h3>
                    <p id="total-net-worth" class="font-bold text-purple-400 dashboard-value">Rp 0</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
             <div class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                <h3 class="text-lg font-semibold text-slate-300 mb-4">Pemasukan vs Pengeluaran</h3>
                <div class="chart-container">
                    <canvas id="incomeExpenseChart"></canvas>
                </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                <h3 class="text-lg font-semibold text-slate-300 mb-4">Distribusi Pengeluaran</h3>
                <div class="chart-container">
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                <h3 class="text-lg font-semibold text-slate-300 mb-4">Distribusi Pemasukan</h3>
                <div class="chart-container">
                    <canvas id="incomePieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-3 space-y-8">
                <section id="category-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold flex items-center gap-3 text-amber-400"><i data-lucide="shield-check"></i> Anggaran Kategori</h2>
                    </div>
                    <div id="category-actions" class="mb-4">
                        <button id="delete-selected-category-btn" data-action="delete-selected-category" class="btn btn-danger w-full disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span class="material-symbols-outlined icon pointer-events-none">delete</span> Arsipkan
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="select-all-categories" class="custom-checkbox rounded">
                        <label for="select-all-categories" class="text-slate-300">Pilih Semua</label>
                    </div>
                    <!-- PERBAIKAN: Form kategori ditambahkan pilihan Tipe Anggaran -->
                    <form id="category-form" class="space-y-3 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="text" id="category-name" placeholder="Nama Kategori" class="input-field" required>
                            <input type="number" id="category-budget" placeholder="Anggaran Bulanan" class="input-field" min="0" required>
                        </div>
                        <select id="category-type" class="input-field">
                            <option value="bill">Tipe: Tagihan (Diingatkan jika belum lunas)</option>
                            <option value="limit">Tipe: Batas Belanja (Diingatkan jika terlampaui)</option>
                        </select>
                        <button type="submit" class="btn btn-primary w-full"><i data-lucide="plus-circle" class="icon"></i> Tambah Kategori</button>
                    </form>
                    <div class="mb-4">
                        <input type="text" id="category-search" placeholder="Cari kategori..." class="input-field">
                    </div>
                    <div id="category-list" class="space-y-4"></div>
                </section>
                
                 <section id="income-category-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold flex items-center gap-3 text-green-400"><i data-lucide="dollar-sign"></i> Kategori Pemasukan</h2>
                    </div>
                    <div id="income-category-actions" class="mb-4">
                        <button id="delete-selected-income-category-btn" data-action="delete-selected-income-category" class="btn btn-danger w-full disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span class="material-symbols-outlined icon pointer-events-none">delete</span> Arsipkan
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="select-all-income-categories" class="custom-checkbox rounded">
                        <label for="select-all-income-categories" class="text-slate-300">Pilih Semua</label>
                    </div>
                    <form id="income-category-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                        <input type="text" id="income-category-name" placeholder="Nama Kategori Pemasukan" class="input-field sm:col-span-2" required>
                        <button type="submit" class="btn btn-primary sm:col-span-1"><i data-lucide="plus-circle" class="icon"></i> Tambah</button>
                    </form>
                    <div class="mb-4">
                        <input type="text" id="income-category-search" placeholder="Cari kategori pemasukan..." class="input-field">
                    </div>
                    <div id="income-category-list" class="space-y-4"></div>
                </section>

                <div id="welcome-panel" class="bg-slate-800 p-8 rounded-2xl shadow-lg text-center" style="display: none;">
                    <h2 class="text-3xl font-bold text-amber-400 mb-4">Selamat Datang di Budget Quest!</h2>
                    <p class="text-slate-300 mb-6 max-w-2xl mx-auto">Untuk memulai, buatlah kategori anggaran pertamamu di atas.</p>
                    <i data-lucide="mouse-pointer-click" class="text-amber-500 w-16 h-16 mx-auto animate-bounce"></i>
                </div>

                <section id="transaction-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg" style="display: none;">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-3 text-blue-400"><i data-lucide="arrow-left-right"></i> Transaksi</h2>
                    <form id="transaction-form" class="space-y-3 mb-6">
                        <h3 class="font-semibold text-slate-300">Tambah Transaksi Baru</h3>
                        <input type="text" id="transaction-description" placeholder="Deskripsi" class="input-field" required>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input type="number" id="transaction-amount" placeholder="Jumlah" class="input-field" min="0" required>
                            <select id="transaction-type" class="input-field">
                                <option value="expense">Pengeluaran</option>
                                <option value="income">Pemasukan</option>
                            </select>
                            <select id="transaction-category" class="input-field">
                                <option value="">Pilih Kategori...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-secondary w-full"><i data-lucide="plus-circle" class="icon"></i> Tambah Transaksi</button>
                    </form>
                    <hr class="border-slate-700 my-6">
                    <div>
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-3">
                             <h3 class="font-semibold text-slate-300">Riwayat Transaksi</h3>
                        </div>
                        <div id="transaction-actions" class="mb-4">
                            <button id="delete-selected-btn" data-action="delete-selected" class="btn btn-danger w-full disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <span class="material-symbols-outlined icon pointer-events-none">delete</span> Hapus
                            </button>
                        </div>
                        <div class="flex items-center gap-3 mb-4">
                           <input type="checkbox" id="select-all-transactions" class="custom-checkbox rounded">
                           <label for="select-all-transactions" class="text-slate-300">Pilih Semua</label>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 mb-2 p-4 bg-slate-900/50 rounded-lg">
                            <input type="text" id="filter-text" placeholder="Cari deskripsi, jumlah, atau tanggal..." class="input-field flex-grow">
                            <div class="flex gap-2">
                                <button id="sort-btn" class="btn bg-slate-700 hover:bg-slate-600 !p-2.5" aria-label="Ubah Urutan">
                                    <svg id="sort-icon-desc" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>
                                    <svg id="sort-icon-asc" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/></svg>
                                </button>
                                <button id="filter-btn" class="btn bg-slate-700 hover:bg-slate-600 !p-2.5" aria-label="Filter Transaksi">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                                </button>
                            </div>
                        </div>
                         <p id="transaction-count" class="text-xs text-slate-400 mb-4 px-4"></p>
                        <div id="transaction-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                    </div>
                </section>
                
                <section id="goals-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold flex items-center gap-3 text-cyan-400"><i data-lucide="flag"></i> Tujuan Keuangan</h2>
                        <button id="delete-selected-goals-btn" data-action="delete-selected-goals" class="btn btn-danger text-sm py-1 px-3 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span class="material-symbols-outlined icon pointer-events-none">delete</span> Hapus
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="select-all-goals" class="custom-checkbox rounded">
                        <label for="select-all-goals" class="text-slate-300">Pilih Semua</label>
                    </div>
                    <form id="goal-form" class="space-y-3 mb-6">
                        <input type="text" id="goal-name" placeholder="Nama Tujuan (misal: Dana Darurat)" class="input-field" required>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="number" id="goal-target" placeholder="Jumlah Target" class="input-field" min="0" required>
                            <input type="date" id="goal-date" class="input-field" required>
                        </div>
                        <button type="submit" class="btn btn-secondary w-full"><i data-lucide="plus-circle" class="icon"></i> Tambah Tujuan</button>
                    </form>
                    <div class="mb-4">
                        <input type="text" id="goal-search" placeholder="Cari tujuan..." class="input-field">
                    </div>
                    <div id="goal-list" class="space-y-4"></div>
                </section>

                 <section id="investment-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold flex items-center gap-3 text-indigo-400"><i data-lucide="candlestick-chart"></i> Portofolio Investasi</h2>
                        <button id="delete-selected-investments-btn" data-action="delete-selected-investments" class="btn btn-danger text-sm py-1 px-3 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span class="material-symbols-outlined icon pointer-events-none">delete</span> Hapus
                        </button>
                    </div>
                     <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="select-all-investments" class="custom-checkbox rounded">
                        <label for="select-all-investments" class="text-slate-300">Pilih Semua</label>
                    </div>
                    <form id="investment-form" class="space-y-3 mb-6">
                        <input type="text" id="investment-name" placeholder="Nama Aset (misal: Saham BBCA)" class="input-field" required>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="number" id="investment-units" placeholder="Jumlah Unit/Lembar" class="input-field" min="0" step="any" required>
                            <input type="number" id="investment-avg-price" placeholder="Harga Beli Rata-rata" class="input-field" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-secondary w-full"><i data-lucide="plus-circle" class="icon"></i> Tambah Aset</button>
                    </form>
                     <div class="mb-4">
                        <input type="text" id="investment-search" placeholder="Cari aset..." class="input-field">
                    </div>
                    <div id="investment-list" class="space-y-4"></div>
                </section>
            </div>

            <aside class="lg:col-span-2 space-y-8">
                <div class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <div class="sm:flex sm:justify-between sm:items-center mb-4">
                        
                        <div class="flex items-center gap-3">
                            <h2 class="text-2xl font-bold text-purple-400 whitespace-nowrap">
                                Profil Petualang
                            </h2>
                            <button id="game-guide-btn" class="text-slate-400 hover:text-white transition-colors" aria-label="Buka Panduan Game">
                                <span class="material-symbols-outlined">sports_esports</span>
                            </button>
                        </div>

                        <div class="mt-2 sm:mt-0">
                            <div id="user-level" class="text-2xl sm:text-3xl font-bold text-amber-400 flex items-center gap-2 justify-start sm:justify-end">
                                <span class="material-symbols-outlined text-3xl">gamepad</span>
                                <span>Lv. 16</span>
                            </div>
                        </div>

                    </div>

                    <div class="w-full">
                        <div class="h-4 bg-slate-700 rounded-full overflow-hidden">
                            <div id="xp-progress" class="h-4 bg-amber-500" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span id="xp-boost-indicator" class="xp-boost-indicator">XP x2</span>
                            <p id="xp-text" class="text-xs text-slate-400">0 / 100 XP</p>
                        </div>
                    </div>
                </div>

                <div id="quest-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-3 text-green-400"><i data-lucide="target"></i> Misi Keuangan</h2>
                    <div id="quest-list" class="space-y-3 mb-6"></div>
                </div>

                <section id="top-spending-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-3 text-red-400"><i data-lucide="trending-down"></i> Top 5 Pengeluaran</h2>
                    <div id="top-spending-list" class="space-y-3"></div>
                </section>

                <section id="debt-section" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                     <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold flex items-center gap-3 text-orange-400"><i data-lucide="book-user"></i> Catatan Utang/Piutang</h2>
                         <button id="delete-selected-debts-btn" data-action="delete-selected-debts" class="btn btn-danger text-sm py-1 px-3 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span class="material-symbols-outlined icon pointer-events-none">delete</span> Hapus
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="select-all-debts" class="custom-checkbox rounded">
                        <label for="select-all-debts" class="text-slate-300">Pilih Semua</label>
                    </div>
                    <form id="debt-form" class="space-y-3 mb-6">
                        <input type="text" id="debt-person" placeholder="Nama Orang" class="input-field" required>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="number" id="debt-amount" placeholder="Jumlah" class="input-field" min="0" required>
                            <select id="debt-type" class="input-field">
                                <option value="debt">Utang Saya</option>
                                <option value="receivable">Piutang (Orang lain utang)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-secondary w-full"><i data-lucide="plus-circle" class="icon"></i> Tambah Catatan</button>
                    </form>
                    <div class="mb-4">
                        <input type="text" id="debt-search" placeholder="Cari nama..." class="input-field">
                    </div>
                    <div id="debt-list" class="space-y-4"></div>
                </section>
                
                 <section class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-3 text-teal-400"><i data-lucide="file-spreadsheet"></i> Ekspor Laporan</h2>
                    <div class="flex justify-center">
                        <button id="export-btn" class="btn btn-primary w-full"><i data-lucide="download" class="icon"></i> Ekspor Laporan Bulan Ini (.xlsx)</button>
                    </div>
                </section>
            </aside>
        </div>
    </main>

    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black/60 z-40"></div>
    <div id="edit-category-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    <div id="edit-income-category-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    <div id="edit-transaction-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    <div id="filter-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    
    <div id="edit-goal-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    <div id="edit-investment-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    <div id="add-funds-goal-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    
    <div id="inventory-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900 p-6 rounded-2xl shadow-lg w-11/12 max-w-2xl z-50">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-amber-400">Inventaris</h2>
            <button id="close-inventory-btn" class="text-slate-400 hover:text-white">&times;</button>
        </div>
        <div id="inventory-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-1">
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50"></div>
    
    <div id="card-use-confirm-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-sm z-50 text-center">
        </div>
    
    <div id="notification-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50 text-center">
        </div>

    <div id="skip-quest-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900 p-6 rounded-2xl shadow-lg w-11/12 max-w-md z-50">
        </div>

    <div id="game-guide-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-2xl z-50">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-amber-400">Panduan Petualang</h2>
            <button id="close-game-guide-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div class="info-modal-content">
            <h3>Selamat Datang di Budget Quest!</h3>
            <p>Ini adalah panduanmu untuk menjadi master keuangan. Disiplin adalah kunci kemenangan!</p>

            <h3>Tujuan Utama</h3>
            <p>Tujuanmu adalah mengelola keuangan dengan baik, menyelesaikan misi-misi, menaikkan level, dan mencapai tujuan finansial jangka panjangmu.</p>

            <h3>Cara Bermain (Mekanisme Inti)</h3>
            <ul>
                <li><strong>Mencatat Transaksi:</strong> Semua dimulai dari sini. Catat setiap pemasukan dan pengeluaran untuk mendapatkan XP dan menyelesaikan misi.</li>
                <li><strong>Misi Keuangan:</strong> Selesaikan berbagai misi (harian, mingguan, bulanan) untuk mendapatkan XP dan hadiah spesial.</li>
                <li><strong>Level & XP:</strong> Semakin banyak XP yang kamu kumpulkan, semakin tinggi levelmu. Kebutuhan XP akan terus meningkat, membuat tantangan semakin seru!</li>
            </ul>
            
            <h3>Fitur Tantangan (🚩)</h3>
            <p>Anda dapat menandai kategori pengeluaran apa pun sebagai 'Tantangan' dengan mengklik ikon bendera (🚩) di sampingnya. Ini akan mengaktifkan misi mingguan khusus: <strong>'Tantangan Tanpa Belanja'</strong>. Jika Anda berhasil tidak melakukan transaksi apa pun di semua kategori yang ditandai selama seminggu penuh, Anda akan menyelesaikan misi tersebut dan mendapatkan hadiah XP.</p>

            <h3>Misi Berhadiah</h3>
            <p>Beberapa misi memiliki peluang untuk memberimu hadiah kartu acak. Perhatikan baik-baik!</p>
            <ul>
                <li><strong>Misi Kumulatif (Non-Berulang):</strong> Misi seperti "Catat transaksi pertamamu", "Buat kategori anggaran pertamamu", atau "Mencapai N Juta Pertama" akan <strong>secara otomatis selesai dan memberikan hadiah</strong> saat kondisi terpenuhi.</li>
                <li><strong>Misi Harian (Login Harian):</strong> Misi ini hanya akan memberikan XP untuk hari Anda login kembali (jika belum diselesaikan untuk hari itu). <strong>Tidak ada XP retroaktif</strong> untuk hari-hari yang terlewat.</li>
                <li><strong>Misi Berulang Mingguan/Bulanan (Contoh: Review pengeluaran, Tanpa Utang Baru):</strong> Misi ini dievaluasi berdasarkan data transaksi dalam periode waktu spesifik (minggu atau bulan berjalan).</li>
                <li><strong>Peluang Hadiah Kartu:</strong>
                    <ul>
                        <li><strong>Misi Harian:</strong> Peluang <strong>3%</strong> untuk mendapatkan 1 Kartu Acak.</li>
                        <li><strong>Misi Mingguan:</strong> Peluang <strong>10%</strong> untuk mendapatkan 1 Kartu Acak.</li>
                        <li><strong>Misi Bulanan:</strong> Peluang <strong>25%</strong> untuk mendapatkan 1 Kartu Acak.</li>
                        <li><strong>Misi Level (Mencapai Level 10, 20, 30, dst.):</strong> Dijamin mendapatkan <strong>1 Kartu Acak</strong>. Khusus untuk level kelipatan 25 (25, 50, 75, dst.), Anda juga akan mendapatkan tambahan <strong>1 Kartu XP Boost x2</strong>.</li>
                        <li><strong>Misi Utama & Stage Kehidupan:</strong> Dijamin mendapatkan <strong>2 Kartu Acak</strong>.</li>
                    </ul>
                </li>
            </ul>

            <h3>Sistem Hukuman</h3>
            <p>Untuk menjaga tantangan, ada konsekuensi jika misi tidak diselesaikan tepat waktu:</p>
            <ul>
                <li><strong>Evaluasi Periode Tidak Aktif:</strong> Saat Anda login kembali setelah tidak aktif, sistem penalti akan mengevaluasi semua misi berulang (kecuali misi login harian) yang terlewat selama periode tersebut.</li>
                <li><strong>Hukuman Akumulatif:</strong> Penalti akan diakumulasikan dan diterapkan secara retroaktif untuk semua misi berulang yang gagal diselesaikan.</li>
                <li><strong>Hukuman Dasar:</strong> Jika kamu gagal menyelesaikan misi Harian, Mingguan, atau Bulanan pada akhir periodenya, XP-mu akan dikurangi <strong>sebesar setengah</strong> dari hadiah XP misi tersebut.</li>
                <li><strong>Hukuman Tambahan (Peluang 10%):</strong> Setiap kali kamu gagal, ada peluang 10% untuk terkena hukuman tambahan. Sistem akan mencoba menghapus <strong>1 Kartu Acak</strong> dari inventarismu. Jika kamu tidak punya kartu, hukuman diganti menjadi <strong>pengurangan XP tambahan</strong>.</li>
                <li><strong>Penting:</strong> Misi login harian <strong>tidak akan pernah memberikan hukuman</strong> jika terlewat.</li>
            </ul>
            
            <h3>Tips Petualang</h3>
            <ul>
                <li>Login setiap hari untuk mendapatkan XP dari Misi Harian.</li>
                <li>Gunakan Kartu Tolak Hukuman untuk misi yang sulit kamu selesaikan.</li>
                <li>Simpan Kartu XP Boost x2 untuk saat yang tepat, misalnya saat kamu akan menyelesaikan banyak misi besar!</li>
            </ul>
        </div>
    </div>

    <div id="dashboard-guide-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-2xl z-50">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-amber-400">Panduan Dasbor</h2>
            <button id="close-dashboard-guide-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div class="info-modal-content">
            <h3>Memahami Dasbor Anda</h3>
            <p>Dasbor adalah pusat kendali keuangan Anda. Berikut adalah penjelasan setiap fiturnya.</p>

            <h3>Panel Utama</h3>
            <ul>
                <li><strong>Pemasukan & Pengeluaran:</strong> Menampilkan total uang yang masuk dan keluar untuk bulan yang sedang ditampilkan.</li>
                <li><strong>Sisa Kas:</strong> Selisih antara pemasukan dan pengeluaran. Nilai positif berarti Anda surplus!</li>
                <li><strong>Saving Rate:</strong> Persentase dari pemasukan yang berhasil Anda simpan.</li>
                <li><strong>Nilai Investasi:</strong> Total nilai terkini dari semua aset di portofolio investasi Anda.</li>
                <li><strong>Total Kekayaan Bersih:</strong> Akumulasi sisa kas dari seluruh waktu ditambah dengan total nilai investasi Anda saat ini.</li>
            </ul>

            <h3>Tujuan Keuangan</h3>
            <p>Fitur ini membantu Anda menetapkan dan melacak target finansial. Cukup tetapkan nama tujuan, jumlah target, dan tanggal target. Anda bisa menambahkan dana ke tujuan secara manual. Saat tujuan tercapai, Anda akan mendapatkan hadiah XP dan kartu secara otomatis dari sistem!</p>
            <p>Rincian hadiahnya adalah sebagai berikut:</p>
            <ul>
                <li>Jika target tujuan <strong>lebih dari Rp 10.000.000</strong>, Anda mendapatkan <strong>1500 XP</strong> dan <strong>2 Kartu Acak</strong>.</li>
                <li>Jika target tujuan <strong>lebih dari Rp 1.000.000</strong>, Anda mendapatkan <strong>500 XP</strong> dan <strong>1 Kartu Acak</strong>.</li>
                <li>Jika target tujuan <strong>Rp 1.000.000 atau kurang</strong>, Anda mendapatkan <strong>100 XP</strong> (tanpa kartu).</li>
            </ul>

            <h3>Portofolio Investasi</h3>
            <p>Catat semua aset investasi Anda di sini, seperti saham, reksa dana, atau kripto. Masukkan jumlah unit dan harga beli rata-rata. Anda dapat memperbarui harga pasar aset secara manual untuk melihat nilai portofolio Anda bertumbuh. Nilai totalnya akan langsung terintegrasi dengan "Total Kekayaan Bersih" di dasbor.</p>

            <h3>Catatan Utang/Piutang</h3>
            <p>Gunakan fitur ini untuk mencatat semua utang Anda kepada orang lain atau piutang (uang yang dipinjam orang lain dari Anda). Anda dapat dengan mudah menandainya sebagai "Lunas" jika sudah selesai.</p>

            <h3>Anggaran Kategori</h3>
            <ul>
                <li><strong>Membuat Kategori:</strong> Cukup isi nama (misal: "Transportasi") dan tentukan anggaran bulanannya.</li>
                <!-- PERBAIKAN: Penjelasan Tipe Kategori diperbarui -->
                <li><strong>Tipe Kategori:</strong> Pilih 'Tagihan' untuk pengeluaran rutin yang harus dipenuhi (misal: sewa, listrik) atau 'Batas Belanja' untuk pengeluaran yang ingin Anda batasi (misal: makan, hiburan).</li>
                <li><strong>Arsipkan:</strong> Tombol ini tidak menghapus kategori, melainkan menyembunyikannya dari daftar aktif.</li>
                <li><strong>Tantangan (🚩):</strong> Klik ikon bendera untuk menandai kategori sebagai 'Tantangan'. Ini akan mengaktifkan misi mingguan 'Tanpa Belanja' untuk kategori tersebut.</li>
            </ul>

            <h3>Transaksi</h3>
            <ul>
                <li><strong>Pencarian & Filter:</strong> Gunakan kotak pencarian dan tombol filter untuk menemukan transaksi spesifik dengan mudah.</li>
                <li><strong>Pilih Semua & Hapus:</strong> Checkbox 'Pilih Semua' hanya akan memilih item yang <strong>sedang terlihat di layar</strong> untuk mencegah penghapusan data yang tidak disengaja.</li>
            </ul>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, doc, query, setDoc, updateDoc, writeBatch, getDocs, where, increment, serverTimestamp, getDoc, runTransaction, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { enableNetwork, disableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Ganti dengan konfigurasi Firebase Anda yang sebenarnya
        const firebaseConfig = {
            apiKey: "AIzaSyAB92PN-HqtddGUmuV8Z7oRQKB88Wutz9I",
            authDomain: "penganggaran-10d4e.firebaseapp.com",
            projectId: "penganggaran-10d4e",
            storageBucket: "penganggaran-10d4e.appspot.com",
            messagingSenderId: "991890030945",
            appId: "1:991890030945:web:8707184aaf989f597a0520"
        };

        let db, auth, userId;
        let allTransactions = [];
        let categories = [];
        let incomeCategories = [];
        let financialGoals = [];
        let debts = [];
        let investments = [];

        let categoryMap = {};
        let userProfile = { level: 1, xp: 0, completedQuests: {}, failedQuests: {}, inventory: {}, activeBoosts: {}, lastPenaltyCheck: null, hasReadGuide: false, hasReadDashboardGuide: false, questRewards: {} }; 
        let listeners = [];
        let incomeExpenseChart, categoryPieChart, incomePieChart;
        let currentDate = new Date();
        let activeFilters = { type: '', category: '' };
        let selectedTransactions = new Set();
        let selectedCategories = new Set();
        let selectedIncomeCategories = new Set();
        let selectedGoals = new Set();
        let selectedDebts = new Set();
        let selectedInvestments = new Set();

        let sortDirection = 'desc';
        
        let isInitialLoadComplete = false;
        let isCreatingProfile = false;

        let notificationQueue = [];
        let isNotificationShowing = false;

        const el = (id) => document.getElementById(id);
        const loadingSpinner = el('loading-spinner');
        const loginScreen = el('login-screen');
        const appContent = el('app-content');
        const errorDisplay = el('error-display');
        const offlineIndicator = el('offline-indicator');
        const welcomePanel = el('welcome-panel');
        const transactionSection = el('transaction-section');
        const googleSignInBtn = el('google-signin-btn');
        const signOutBtn = el('signout-btn');
        const userProfileDisplay = el('user-profile-display');
        const currentMonthDisplay = el('current-month-display');
        const prevMonthBtn = el('prev-month-btn');
        const nextMonthBtn = el('next-month-btn');
        const todayBtn = el('today-btn');
        const filterBtn = el('filter-btn');
        const sortBtn = el('sort-btn');
        const transactionCountEl = el('transaction-count');
        const filterModal = el('filter-modal');
        const editCategoryModal = el('edit-category-modal');
        const editIncomeCategoryModal = el('edit-income-category-modal');
        const editTransactionModal = el('edit-transaction-modal');
        const confirmModal = el('confirm-modal');
        
        const notificationModal = el('notification-modal');
        const inventoryModal = el('inventory-modal');
        const cardUseConfirmModal = el('card-use-confirm-modal');
        const skipQuestModal = el('skip-quest-modal');
        const gameGuideModal = el('game-guide-modal');
        const dashboardGuideModal = el('dashboard-guide-modal');
        const inventoryBtn = el('inventory-btn');
        const gameGuideBtn = el('game-guide-btn');
        const dashboardGuideBtn = el('dashboard-guide-btn');
        const modalBackdrop = el('modal-backdrop');
        const deleteSelectedBtn = el('delete-selected-btn');
        const deleteSelectedCategoryBtn = el('delete-selected-category-btn');
        const deleteSelectedIncomeCategoryBtn = el('delete-selected-income-category-btn');
        const selectAllCategoriesCheckbox = el('select-all-categories');
        const selectAllTransactionsCheckbox = el('select-all-transactions');
        const selectAllIncomeCategoriesCheckbox = el('select-all-income-categories');

        const editGoalModal = el('edit-goal-modal');
        const editInvestmentModal = el('edit-investment-modal');
        const addFundsGoalModal = el('add-funds-goal-modal');

        const deleteSelectedGoalsBtn = el('delete-selected-goals-btn');
        const deleteSelectedDebtsBtn = el('delete-selected-debts-btn');
        const deleteSelectedInvestmentsBtn = el('delete-selected-investments-btn');
        const selectAllGoalsCheckbox = el('select-all-goals');
        const selectAllDebtsCheckbox = el('select-all-debts');
        const selectAllInvestmentsCheckbox = el('select-all-investments');

        let allQuests = [];

        const CARD_TYPES = {
            'xp_bonus': { name: 'Kartu XP Tambahan', description: 'Memberikan bonus 100 XP.', icon: 'stars', iconColor: 'text-blue-400', footerColor: 'bg-blue-500' },
            'penalty_negation': { name: 'Kartu Tolak Hukuman', description: 'Otomatis digunakan untuk membatalkan hukuman.', icon: 'shield', iconColor: 'text-amber-400', footerColor: 'bg-amber-500' },
            'skip_weekly': { name: 'Kartu Lewati Misi Mingguan', description: 'Langsung selesaikan 1 misi mingguan.', icon: 'fast_forward', iconColor: 'text-cyan-400', footerColor: 'bg-cyan-500' },
            'skip_monthly': { name: 'Kartu Lewati Misi Bulanan', description: 'Langsung selesaikan 1 misi bulanan.', icon: 'skip_next', iconColor: 'text-green-400', footerColor: 'bg-green-500' },
            'exp_boost_x2': { name: 'Kartu XP Boost x2', description: 'Gandakan semua XP yang didapat selama 1 bulan.', icon: 'rocket_launch', iconColor: 'text-violet-400', footerColor: 'bg-violet-500' }
        };
        
        // --- Gamification Logic ---

        function defineQuests() {
            const baseQuests = [
                { id: 'q1', text: 'Catat transaksi pertamamu', xp: 20, category: 'Misi Dasar', type: 'log_transaction_total', target: 1, recurring: false },
                { id: 'q2', text: 'Buat kategori anggaran pertamamu', xp: 30, category: 'Misi Dasar', type: 'create_category', target: 1, recurring: false },
                { id: 'daily_login', text: 'Login Harian', xp: 10, category: 'Misi Harian', type: 'daily_login', recurring: true, noPenalty: true, rewardChance: 0.03 },
                { id: 'weekly_no_spend_challenge', text: 'Tantangan Tanpa Belanja Mingguan', xp: 75, category: 'Misi Mingguan', type: 'no_spend_challenge', recurring: true, rewardChance: 0.10 },
                { id: 'weekly_review', text: 'Review pengeluaran mingguan', xp: 50, category: 'Misi Mingguan', type: 'manual', recurring: true },
                { id: 'weekly_no_new_debt', text: 'Tidak ada utang baru minggu ini', xp: 75, category: 'Misi Mingguan', type: 'manual', recurring: true, rewardChance: 0.10 },
                { id: 'q3', text: 'Catat 5 transaksi bulan ini', xp: 50, category: 'Misi Bulanan', type: 'log_transaction_monthly', target: 5, recurring: true },
                { id: 'monthly_special', text: 'Catat 20 transaksi bulan ini', xp: 100, category: 'Misi Bulanan', type: 'log_transaction_monthly', target: 20, recurring: true, rewardChance: 0.25 },
                { id: 'm1', text: 'Saving rate di atas 50%', xp: 200, category: 'Misi Bulanan', type: 'saving_rate', target: 50, recurring: true },
                { id: 'monthly_bills_on_time', text: 'Bayar semua tagihan tepat waktu bulan ini', xp: 100, category: 'Misi Bulanan', type: 'manual', recurring: true, rewardChance: 0.10 },
                { id: 'monthly_emergency_fund', text: 'Tambah saldo dana darurat bulan ini', xp: 150, category: 'Misi Bulanan', type: 'manual', recurring: true, rewardChance: 0.15 },
                { id: 'g1', text: 'Umroh', xp: 2500, category: 'Misi Utama', type: 'manual', recurring: false, guaranteedReward: 2 },
                { id: 'g2', text: 'Membeli Penthouse', xp: 10000, category: 'Misi Utama', type: 'manual', recurring: false, guaranteedReward: 2 },
                { id: 'g3', text: 'Membelikan Orang Tua Mobil', xp: 5000, category: 'Misi Utama', type: 'manual', recurring: false, guaranteedReward: 2 },
                { id: 'g4', text: 'Membeli Mobil Sport', xp: 7500, category: 'Misi Utama', type: 'manual', recurring: false, guaranteedReward: 2 },
                { id: 's1', text: 'Mencapai 100 Juta Pertama', xp: 1000, category: 'Stage Kehidupan', type: 'manual', target: 100000000, recurring: false, guaranteedReward: 2 },
                { id: 's2', text: 'Mencapai 1 Miliar Pertama', xp: 5000, category: 'Stage Kehidupan', type: 'manual', target: 1000000000, recurring: false, guaranteedReward: 2 },
                { id: 's3', text: 'Mencapai 10 Miliar Pertama', xp: 10000, category: 'Stage Kehidupan', type: 'manual', target: 10000000000, recurring: false, guaranteedReward: 2 },
                { id: 's4', text: 'Mencapai 100 Miliar Pertama', xp: 50000, category: 'Stage Kehidupan', type: 'manual', target: 100000000000, recurring: false, guaranteedReward: 2 },
                { id: 's5', text: 'Mencapai 1 Triliun Pertama', xp: 100000, category: 'Stage Kehidupan', type: 'manual', target: 1000000000000, recurring: false, guaranteedReward: 2 },
            ];

            const levelQuests = [];
            for (let i = 10; i <= 200; i++) {
                let questData = null;
                if (i % 25 === 0) {
                    questData = { id: `lq${i}`, text: `Mencapai Level ${i}`, xp: i * 50, category: 'Misi Level', type: 'level_reach', target: i, recurring: false, guaranteedBoost: true, guaranteedReward: 1 };
                } else if (i % 10 === 0) {
                    questData = { id: `lq${i}`, text: `Mencapai Level ${i}`, xp: i * 50, category: 'Misi Level', type: 'level_reach', target: i, recurring: false, guaranteedReward: 1 };
                }
                if (questData) {
                    levelQuests.push(questData);
                }
            }
            allQuests = [...baseQuests, ...levelQuests];
        }

        const toTitleCase = (str) => !str ? '' : str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
        const showError = (message) => { errorDisplay.textContent = message; errorDisplay.classList.remove('hidden'); };
        const hideError = () => errorDisplay.classList.add('hidden');

        const formatDashboardValue = (value) => {
            // Menggunakan fungsi baru untuk menyingkat angka jika perlu
            const formattedValue = formatCompactCurrency(value); 
            const len = formattedValue.length;

            // Ukuran font tetap dinamis, namun sekarang berdasarkan teks yang lebih pendek
            let fontSize = '1.875rem'; // text-3xl
            if (len > 15) fontSize = '1.25rem'; // text-xl
            else if (len > 10) fontSize = '1.5rem'; // text-2xl
            
            // Khusus untuk 'Rp 0' atau nilai kecil lainnya
            if (Math.abs(value) < 1000000) {
                const originalFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
                if (originalFormatted.length > 12) fontSize = '1.5rem';
            }

            return `<span style="font-size: ${fontSize}; line-height: 1.2;">${formattedValue}</span>`;
        };

        function updateActionButtonsState() {
            deleteSelectedBtn.disabled = selectedTransactions.size === 0;
            deleteSelectedCategoryBtn.disabled = selectedCategories.size === 0;
            deleteSelectedIncomeCategoryBtn.disabled = selectedIncomeCategories.size === 0;
            deleteSelectedGoalsBtn.disabled = selectedGoals.size === 0;
            deleteSelectedDebtsBtn.disabled = selectedDebts.size === 0;
            deleteSelectedInvestmentsBtn.disabled = selectedInvestments.size === 0;
        }

        function renderAll() {
            if (!isInitialLoadComplete) return;
            renderDashboard();
            renderCategories();
            renderIncomeCategories();
            renderTransactionCategoryDropdown();
            renderTransactions();
            renderQuests();
            updateUserProfileUI();
            renderCharts();
            renderSmartReminders(); // PERBAIKAN: Memanggil fungsi pengingat baru
            
            renderGoals();
            renderDebts();
            renderInvestments();
            renderTopSpendingCategories();

            updateActionButtonsState();

            const sortIconDesc = el('sort-icon-desc'), sortIconAsc = el('sort-icon-asc');
            if (sortIconAsc && sortIconDesc) {
                sortIconDesc.classList.toggle('hidden', sortDirection !== 'desc');
                sortIconAsc.classList.toggle('hidden', sortDirection !== 'asc');
            }
            const hasCategories = categories.filter(c => !c.isArchived).length > 0;
            welcomePanel.style.display = hasCategories ? 'none' : 'block';
            transactionSection.style.display = hasCategories ? 'block' : 'none';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function getTransactionsForMonth(date) {
            const start = new Date(date.getFullYear(), date.getMonth(), 1);
            const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            end.setHours(23, 59, 59, 999);
            return allTransactions.filter(t => { const d = new Date(t.date); return d >= start && d <= end; });
        }

        function renderDashboard() {
            const transactions = getTransactionsForMonth(currentDate);
            const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            currentMonthDisplay.textContent = startOfMonth.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const now = new Date();
            const startOfCurrentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            nextMonthBtn.disabled = startOfMonth >= startOfCurrentMonth;
            nextMonthBtn.classList.toggle('opacity-50', nextMonthBtn.disabled);
            nextMonthBtn.classList.toggle('cursor-not-allowed', nextMonthBtn.disabled);
            
            const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const balance = income - expenses;
            const savingRate = income > 0 ? Math.max(0, ((balance / income) * 100)).toFixed(0) : 0;
            
            const totalCashBalance = allTransactions.reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0);
            const investmentValue = investments.reduce((sum, asset) => sum + (asset.units * (asset.currentPrice || asset.avgPrice)), 0);
            const netWorth = totalCashBalance + investmentValue;

            el('total-income').innerHTML = formatDashboardValue(income);
            el('total-expenses').innerHTML = formatDashboardValue(expenses);
            el('balance').innerHTML = formatDashboardValue(balance);
            el('saving-rate').textContent = `${savingRate}%`;
            el('investment-value').innerHTML = formatDashboardValue(investmentValue);
            el('total-net-worth').innerHTML = formatDashboardValue(netWorth);
        }

        function renderCategories() {
            const transactions = getTransactionsForMonth(currentDate);
            const listEl = el('category-list');
            const searchTerm = el('category-search').value.toLowerCase();
            const filteredCategories = categories.filter(cat => !cat.isArchived && cat.name.toLowerCase().includes(searchTerm));
            const categoriesWithSpent = filteredCategories.map(cat => {
                const spent = transactions.filter(t => t.category === cat.id && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                return { ...cat, spent, progress: cat.budget > 0 ? (spent / cat.budget) * 100 : 0 };
            });
            
            selectAllCategoriesCheckbox.checked = filteredCategories.length > 0 && filteredCategories.every(cat => selectedCategories.has(cat.id));
            
            listEl.innerHTML = categoriesWithSpent.map(cat => {
                const progressColor = cat.progress > 100 ? 'bg-red-500' : cat.progress > 75 ? 'bg-yellow-500' : 'bg-green-500';
                const isSelected = selectedCategories.has(cat.id);
                const isChallenge = cat.isChallenge || false;
                // PERBAIKAN: Menampilkan label tipe kategori
                const typeLabel = cat.type === 'limit' ? 'Batas Belanja' : 'Tagihan';
                const typeColor = cat.type === 'limit' ? 'text-cyan-400' : 'text-yellow-400';

                return `
                    <div class="bg-slate-700/50 p-4 rounded-lg flex items-center gap-4">
                        <input type="checkbox" data-id="${cat.id}" class="category-checkbox custom-checkbox rounded" ${isSelected ? 'checked' : ''}>
                        <div class="flex-grow">
                             <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start">
                                <div>
                                    <h4 class="text-lg font-bold text-slate-200 mb-1">${cat.name}</h4>
                                    <span class="text-xs font-semibold ${typeColor}">${typeLabel}</span>
                                </div>
                                <span class="text-sm text-slate-300 mt-1 sm:mt-0">${formatCurrency(cat.spent)} / ${formatCurrency(cat.budget)}</span>
                            </div>
                            <div class="w-full bg-slate-600 rounded-full h-2.5 mt-2">
                                <div class="${progressColor} h-2.5 rounded-full" style="width: ${Math.min(cat.progress, 100)}%"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined action-icon challenge-flag ${isChallenge ? 'active' : ''}" data-action="toggle-challenge" data-id="${cat.id}" title="Tandai sebagai Tantangan: Aktifkan misi tanpa belanja untuk kategori ini.">flag</span>
                            <span class="material-symbols-outlined action-icon" data-action="edit-category" data-id="${cat.id}" aria-label="Edit Kategori">edit</span>
                        </div>
                    </div>`;
            }).join('') || `<p class="text-slate-500 text-center py-4">Tidak ada kategori yang cocok.</p>`;
        }
        
        function renderIncomeCategories() {
            const listEl = el('income-category-list');
            const searchTerm = el('income-category-search').value.toLowerCase();
            const filteredCategories = incomeCategories.filter(cat => !cat.isArchived && cat.name.toLowerCase().includes(searchTerm));
            
            selectAllIncomeCategoriesCheckbox.checked = filteredCategories.length > 0 && filteredCategories.every(cat => selectedIncomeCategories.has(cat.id));
            
            listEl.innerHTML = filteredCategories.map(cat => {
                const isSelected = selectedIncomeCategories.has(cat.id);
                return `
                    <div class="bg-slate-700/50 p-4 rounded-lg flex items-center gap-4 justify-between">
                        <div class="flex items-center gap-4">
                            <input type="checkbox" data-id="${cat.id}" class="income-category-checkbox custom-checkbox rounded" ${isSelected ? 'checked' : ''}>
                            <h4 class="text-lg font-bold text-slate-200">${cat.name}</h4>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined action-icon" data-action="edit-income-category" data-id="${cat.id}" aria-label="Edit Kategori Pemasukan">edit</span>
                        </div>
                    </div>`;
            }).join('') || `<p class="text-slate-500 text-center py-4">Belum ada kategori pemasukan.</p>`;
        }

        function renderTransactionCategoryDropdown() {
            const type = el('transaction-type').value;
            const dropdown = el('transaction-category');
            const list = type === 'income' ? incomeCategories : categories;
            dropdown.innerHTML = '<option value="">Pilih Kategori...</option>' + list.filter(c => !c.isArchived).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        function getFilteredTransactions() {
            const transactionsForMonth = getTransactionsForMonth(currentDate);
            const searchTerm = el('filter-text').value.toLowerCase();
            return transactionsForMonth.filter(t => {
                const dateNum = new Date(t.date).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const dateLong = new Date(t.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }).toLowerCase();
                const searchMatch = searchTerm === '' || t.description.toLowerCase().includes(searchTerm) || t.amount.toString().includes(searchTerm) || dateNum.includes(searchTerm) || dateLong.includes(searchTerm);
                const typeMatch = !activeFilters.type || t.type === activeFilters.type;
                const categoryMatch = !activeFilters.category || t.category === activeFilters.category;
                return searchMatch && typeMatch && categoryMatch;
            });
        }

        function renderTransactions() {
            const listEl = el('transaction-list');
            const transactionsForMonth = getTransactionsForMonth(currentDate);
            const filteredTransactions = getFilteredTransactions();
            transactionCountEl.textContent = `Menampilkan ${filteredTransactions.length} dari ${transactionsForMonth.length} transaksi.`;
            const sorted = [...filteredTransactions].sort((a, b) => sortDirection === 'desc' ? b.date - a.date : a.date - b.date);
            
            selectAllTransactionsCheckbox.checked = sorted.length > 0 && sorted.every(t => selectedTransactions.has(t.id));
            
            listEl.innerHTML = sorted.map(t => {
                const isIncome = t.type === 'income';
                const categoryName = categoryMap[t.category] || 'Tanpa Kategori';
                const isSelected = selectedTransactions.has(t.id);
                const dateStr = new Date(t.date).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                // ... di dalam return `renderTransactions`
                return `
                    <div>
                        <div class="bg-slate-700/50 p-3 rounded-lg flex flex-wrap justify-between items-center gap-x-3 gap-y-2 sm:hidden">
                            <div class="flex items-center gap-3 flex-grow min-w-0">
                                <input type="checkbox" data-id="${t.id}" class="transaction-checkbox custom-checkbox rounded flex-shrink-0 self-start mt-1" ${isSelected ? 'checked' : ''}>
                                <div class="flex-grow min-w-0">
                                    <p class="font-medium text-slate-200 whitespace-normal break-words">${t.description}</p>
                                </div>
                            </div>
                            <div class="w-full sm:w-auto text-right">
                                <p class="font-semibold text-lg ${isIncome ? 'text-green-400' : 'text-red-400'}">${formatCurrency(t.amount)}</p>
                            </div>
                            <div class="w-full flex justify-between items-center text-xs text-slate-400 pt-2 border-t border-slate-700/50">
                                <span>${dateStr} - (${categoryName})</span>
                                <span class="material-symbols-outlined action-icon" data-action="edit-transaction" data-id="${t.id}" aria-label="Edit Transaksi">edit</span>
                            </div>
                        </div>

                        <div class="bg-slate-700/50 p-3 rounded-lg hidden sm:flex items-center justify-between gap-3">
                            <div class="flex items-center gap-3 flex-grow min-w-0">
                                <input type="checkbox" data-id="${t.id}" class="transaction-checkbox custom-checkbox rounded flex-shrink-0" ${isSelected ? 'checked' : ''}>
                                <div class="flex-grow min-w-0">
                                    <p class="font-medium text-slate-200 truncate" title="${t.description}">${t.description}</p>
                                    <p class="text-xs text-slate-400">${dateStr} - ${isIncome ? 'Pemasukan' : `Pengeluaran`} (${categoryName})</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 flex-shrink-0">
                                <p class="font-semibold ${isIncome ? 'text-green-400' : 'text-red-400'}">${formatCurrency(t.amount)}</p>
                                <span class="material-symbols-outlined action-icon" data-action="edit-transaction" data-id="${t.id}" aria-label="Edit Transaksi">edit</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || `<p class="text-slate-500 text-center py-4">Tidak ada transaksi yang cocok.</p>`;
        }
        
        // PERBAIKAN: Logika perhitungan XP untuk naik level dibuat konsisten.
        function getXpNeededForLevelUp(level) {
            // Formula sederhana: 100 XP untuk level 1, dan meningkat 15% setiap levelnya.
            // Ini memastikan progresi yang mulus dan dapat diprediksi.
            return Math.floor(100 * Math.pow(1.15, level - 1));
        }

        function calculateLevelAndProgress(totalXp) {
            let level = 1, tempXp = totalXp, xpForNext = getXpNeededForLevelUp(level);
            while (tempXp >= xpForNext) {
                tempXp -= xpForNext;
                level++;
                xpForNext = getXpNeededForLevelUp(level);
            }
            return { level, xpProgress: tempXp, xpNeeded: xpForNext };
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return [d.getUTCFullYear(), Math.ceil((((d - yearStart) / 86400000) + 1) / 7)];
        }

        function renderQuests() {
            const listEl = el('quest-list');
            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];
            const [year, week] = getWeekNumber(now);
            const weekKey = `${year}-W${week}`;
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            const groupedQuests = allQuests.reduce((acc, q) => { (acc[q.category] = acc[q.category] || []).push(q); return acc; }, {});
            let html = '';
            const categoryOrder = ['Misi Harian', 'Misi Mingguan', 'Misi Bulanan', 'Misi Dasar', 'Misi Level', 'Misi Utama', 'Stage Kehidupan'];
            for (const category of categoryOrder) {
                if (groupedQuests[category]) {
                    let hasUncompleted = false;
                    if (['Misi Harian', 'Misi Mingguan', 'Misi Bulanan'].includes(category)) {
                        hasUncompleted = groupedQuests[category].some(q => {
                            let key;
                            if (q.category === 'Misi Harian') key = `${q.id}_${dateKey}`;
                            else if (q.category === 'Misi Mingguan') key = `${q.id}_${weekKey}`;
                            else key = `${q.id}_${monthKey}`;
                            return !userProfile.completedQuests[key] && !userProfile.failedQuests[key];
                        });
                    }
                    const alertIcon = hasUncompleted ? `<span class="material-symbols-outlined text-yellow-400 text-xl">priority_high</span>` : '';
                    html += `
                        <div class="quest-category-item">
                            <h3 class="quest-category-header font-semibold text-slate-300 mt-4 mb-2 flex items-center justify-between">
                                <span class="flex items-center gap-2">${category} ${alertIcon}</span>
                                <span class="quest-arrow-container"><span class="material-symbols-outlined quest-arrow-right">keyboard_arrow_right</span><span class="material-symbols-outlined quest-arrow-down hidden">keyboard_arrow_down</span></span>
                            </h3>
                            <div class="quest-category-content pl-4 space-y-3">
                    ` + groupedQuests[category].map(q => {
                        let questIdToCheck = q.id;
                        if (q.recurring) {
                            if (q.category === 'Misi Harian') questIdToCheck = `${q.id}_${dateKey}`;
                            else if (q.category === 'Misi Mingguan') questIdToCheck = `${q.id}_${weekKey}`;
                            else questIdToCheck = `${q.id}_${monthKey}`;
                        }
                        const isCompleted = userProfile.completedQuests[questIdToCheck];
                        const isFailed = userProfile.failedQuests[questIdToCheck];
                        let iconHtml = isCompleted ? `<i data-lucide="check-circle-2" class="text-green-400"></i>` : isFailed ? `<i data-lucide="x-circle" class="text-red-400"></i>` : `<i data-lucide="award" class="text-amber-400"></i>`;
                        let buttonHtml = (q.type === 'manual' && !isCompleted && !isFailed) ? `<button data-action="complete-quest" data-id="${q.id}" class="btn btn-primary text-xs py-1 px-2 mt-2">Selesaikan</button>` : '';
                        
                        const hasGuaranteedCard = userProfile.questRewards && userProfile.questRewards[questIdToCheck];
                        const rewardText = (hasGuaranteedCard || q.guaranteedReward) ? `<span class="text-xs text-yellow-400 font-bold ml-2">+ Kartu</span>` : '';
                        
                        let questText = q.text;
                        if (q.type === 'no_spend_challenge') {
                            const challengeCats = categories.filter(c => c.isChallenge).map(c => c.name);
                            if (challengeCats.length > 0) {
                                questText = `Tidak ada pengeluaran di: <strong>${challengeCats.join(', ')}</strong> minggu ini.`;
                            } else {
                                questText = 'Tandai kategori sebagai "Tantangan" (🚩) untuk memulai misi ini.';
                            }
                        }

                        return `
                            <div class="bg-slate-700/50 p-3 rounded-lg ${isCompleted || isFailed ? 'opacity-60' : ''}">
                                <div class="flex items-start gap-4">
                                    <div class="mt-1">${iconHtml}</div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-slate-200">${questText}${q.id === 'm1' ? ' <span class="text-xs text-slate-400">(Dievaluasi akhir bulan)</span>' : ''}</p>
                                        <p class="text-sm text-green-400">+${q.xp} XP ${rewardText}</p>
                                        ${buttonHtml}
                                    </div>
                                </div>
                            </div>`;
                    }).join('') + `</div></div>`;
                }
            }
            listEl.innerHTML = html;
        }

        async function updateUserProfileUI() {
            if (!userProfile) return;
            const { level, xpProgress, xpNeeded } = calculateLevelAndProgress(userProfile.xp || 0);
            
            if (level > userProfile.level) {
                showNotificationModal('Naik Level!', 'military_tech', `Selamat! Anda telah mencapai <strong>Level ${level}</strong>!`, 'amber');
                userProfile.level = level;
                await updateDoc(doc(db, `users/${userId}/profile/main`), { level: level });
                await checkAndCompleteQuests(); 
            }

            el('user-level').textContent = `Lv. ${level}`;
            el('xp-progress').style.width = `${(xpProgress / xpNeeded) * 100}%`;
            el('xp-text').textContent = `${xpProgress} / ${xpNeeded} XP`;
            const inventoryCount = Object.values(userProfile.inventory || {}).reduce((s, c) => s + c, 0);
            const inventoryCountEl = el('inventory-count');
            inventoryCountEl.textContent = inventoryCount;
            inventoryCountEl.classList.toggle('hidden', inventoryCount === 0);
            const boostIndicator = el('xp-boost-indicator');
            const boostUntil = userProfile.activeBoosts?.exp_boost_x2_until;
            boostIndicator.style.display = (boostUntil && boostUntil > Date.now()) ? 'inline-block' : 'none';
            if (boostUntil && boostUntil <= Date.now() && !userProfile.boostExpiryNotified) {
                showNotificationModal('Boost Berakhir', 'rocket', 'Periode XP Boost x2 telah berakhir.', 'amber');
                await updateDoc(doc(db, `users/${userId}/profile/main`), { 'boostExpiryNotified': true });
            }
        }
        
        function renderCharts() {
            const transactions = getTransactionsForMonth(currentDate);
            const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const barCtx = el('incomeExpenseChart').getContext('2d');
            if (incomeExpenseChart) incomeExpenseChart.destroy();
            incomeExpenseChart = new Chart(barCtx, { type: 'bar', data: { labels: ['Bulan Ini'], datasets: [{ label: 'Pemasukan', data: [income], backgroundColor: 'rgba(74, 222, 128, 0.6)' }, { label: 'Pengeluaran', data: [expenses], backgroundColor: 'rgba(248, 113, 113, 0.6)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } }, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } } });
            const expenseByCategory = categories.filter(c => !c.isArchived).map(cat => ({ name: cat.name, total: transactions.filter(t => t.category === cat.id && t.type === 'expense').reduce((s, t) => s + t.amount, 0) })).filter(c => c.total > 0);
            const uncategorizedExpenses = transactions.filter(t => t.type === 'expense' && !t.category).reduce((s, t) => s + t.amount, 0);
            if (uncategorizedExpenses > 0) expenseByCategory.push({ name: 'Tanpa Kategori', total: uncategorizedExpenses });
            const pieCtx = el('categoryPieChart').getContext('2d');
            if (categoryPieChart) categoryPieChart.destroy();
            categoryPieChart = new Chart(pieCtx, { type: 'pie', data: { labels: expenseByCategory.map(c => c.name), datasets: [{ data: expenseByCategory.map(c => c.total), backgroundColor: ['#34D399', '#F87171', '#60A5FA', '#FBBF24', '#A78BFA', '#EC4899', '#94A3b8'], borderColor: '#0F172A' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } } });
            const incomeByCategory = incomeCategories.filter(c => !c.isArchived).map(cat => ({ name: cat.name, total: transactions.filter(t => t.category === cat.id && t.type === 'income').reduce((s, t) => s + t.amount, 0) })).filter(c => c.total > 0);
            const uncategorizedIncome = transactions.filter(t => t.type === 'income' && !t.category).reduce((s, t) => s + t.amount, 0);
            if (uncategorizedIncome > 0) incomeByCategory.push({ name: 'Tanpa Kategori', total: uncategorizedIncome });
            const incomePieCtx = el('incomePieChart').getContext('2d');
            if (incomePieChart) incomePieChart.destroy();
            incomePieChart = new Chart(incomePieCtx, { type: 'pie', data: { labels: incomeByCategory.map(c => c.name), datasets: [{ data: incomeByCategory.map(c => c.total), backgroundColor: ['#22C55E', '#84CC16', '#10B981', '#14B8A6', '#06B6D4', '#0EA5E9', '#3B82F6'], borderColor: '#0F172A' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } } });
        }
        
        function getRandomCard() {
            const rand = Math.random();
            if (rand < 0.01) return 'exp_boost_x2';
            if (rand < 0.08) return 'penalty_negation';
            if (rand < 0.12) return 'skip_weekly';
            if (rand < 0.15) return 'skip_monthly';
            return 'xp_bonus';
        }

        async function checkAndCompleteQuests(triggeredByAction = null) {
            if (!isInitialLoadComplete) return;
            const now = new Date();
            const [year, week] = getWeekNumber(now);
            const weekKey = `${year}-W${week}`;
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            const transactionsThisMonth = getTransactionsForMonth(currentDate);
            const isLastDay = now.getDate() === new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const monthlyIncome = transactionsThisMonth.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const savingRate = monthlyIncome > 0 ? Math.max(0, ((monthlyIncome - transactionsThisMonth.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0)) / monthlyIncome) * 100) : 0;
            const updates = {};
            let xpGained = 0;
            let cardsGained = {};

            for (const quest of allQuests) {
                // PERBAIKAN: Misi login harian tidak dicek di sini lagi.
                if (quest.type === 'manual' || quest.type === 'no_spend_challenge' || quest.type === 'daily_login') {
                    continue;
                }

                let questIdToCheck = quest.id;
                if (quest.recurring) {
                    if (quest.category === 'Misi Mingguan') questIdToCheck = `${quest.id}_${weekKey}`;
                    else questIdToCheck = `${quest.id}_${monthKey}`;
                }

                if (userProfile.completedQuests[questIdToCheck] || userProfile.failedQuests[questIdToCheck]) continue;

                let isCompleted = false;
                if (triggeredByAction && triggeredByAction.questId === quest.id) {
                    isCompleted = true; 
                } else {
                    switch (quest.type) {
                        case 'log_transaction_total': if (allTransactions.length >= quest.target) isCompleted = true; break;
                        case 'create_category': if (categories.length >= quest.target) isCompleted = true; break;
                        case 'log_transaction_monthly': if (transactionsThisMonth.length >= quest.target) isCompleted = true; break;
                        case 'level_reach': if (userProfile.level >= quest.target) isCompleted = true; break;
                        case 'saving_rate': if (isLastDay && savingRate >= quest.target) isCompleted = true; break;
                    }
                }

                if (isCompleted) {
                    updates[`completedQuests.${questIdToCheck}`] = true;
                    let currentXpReward = quest.xp;
                    if (userProfile.activeBoosts?.exp_boost_x2_until > Date.now()) {
                        currentXpReward *= 2;
                        showNotificationModal('Misi Selesai!', 'military_tech', `XP Boost Aktif! Anda menyelesaikan "${quest.text}" dan mendapatkan <strong>+${currentXpReward} XP</strong>!`, 'green');
                    } else {
                        showNotificationModal('Misi Selesai!', 'military_tech', `Anda menyelesaikan "${quest.text}" dan mendapatkan <strong>+${currentXpReward} XP</strong>!`, 'green');
                    }
                    xpGained += currentXpReward;
                    if (quest.guaranteedBoost) {
                        cardsGained['exp_boost_x2'] = (cardsGained['exp_boost_x2'] || 0) + 1;
                        showNotificationModal('Hadiah Spesial!', 'workspace_premium', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES['exp_boost_x2'].name}</strong>!`, 'violet');
                    }
                    if (quest.guaranteedReward) {
                        for (let i = 0; i < quest.guaranteedReward; i++) {
                            const cardId = getRandomCard();
                            cardsGained[cardId] = (cardsGained[cardId] || 0) + 1;
                            showNotificationModal('Hadiah Didapat!', 'card_giftcard', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES[cardId].name}</strong>!`, 'blue');
                        }
                    } else if (userProfile.questRewards && userProfile.questRewards[questIdToCheck]) {
                        const cardId = getRandomCard();
                        cardsGained[cardId] = (cardsGained[cardId] || 0) + 1;
                        showNotificationModal('Beruntung!', 'auto_awesome', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES[cardId].name}</strong>!`, 'blue');
                    }
                }
            }
            if (xpGained > 0) updates.xp = increment(xpGained);
            for (const cardId in cardsGained) updates[`inventory.${cardId}`] = increment(cardsGained[cardId]);
            if (Object.keys(updates).length > 0) await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
        }
        
        // PERBAIKAN: Fungsi baru yang lebih efisien khusus untuk login harian.
        async function completeDailyLoginQuest() {
            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];
            const questId = 'daily_login';
            const questIdToCheck = `${questId}_${dateKey}`;
            
            if (userProfile.completedQuests[questIdToCheck]) return; // Sudah selesai hari ini

            const quest = allQuests.find(q => q.id === questId);
            if (!quest) return;

            const updates = {};
            let xpGained = quest.xp;
            let cardsGained = {};

            if (userProfile.activeBoosts?.exp_boost_x2_until > Date.now()) {
                xpGained *= 2;
            }
            updates.xp = increment(xpGained);
            updates[`completedQuests.${questIdToCheck}`] = true;

            if (userProfile.questRewards && userProfile.questRewards[questIdToCheck]) {
                const cardId = getRandomCard();
                cardsGained[cardId] = (cardsGained[cardId] || 0) + 1;
            }

            for (const cardId in cardsGained) {
                updates[`inventory.${cardId}`] = increment(cardsGained[cardId]);
            }

            await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
            
            showNotificationModal('Login Harian!', 'event_available', `Anda mendapatkan <strong>+${xpGained} XP</strong> untuk login hari ini!`, 'green');
            if (Object.keys(cardsGained).length > 0) {
                const cardId = Object.keys(cardsGained)[0];
                showNotificationModal('Hadiah Harian!', 'card_giftcard', `Anda beruntung dan mendapatkan: <strong>1x ${CARD_TYPES[cardId].name}</strong>!`, 'blue');
            }
        }

        // PERBAIKAN: Fungsi evaluasi misi mingguan dipisahkan dari fungsi penalti.
        async function evaluateWeeklyQuests(weekKey, startOfWeek, endOfWeek, updates) {
            const quest = allQuests.find(q => q.id === 'weekly_no_spend_challenge');
            if (!quest) return;
            
            const questIdToCheck = `${quest.id}_${weekKey}`;
            if (userProfile.completedQuests[questIdToCheck] || userProfile.failedQuests[questIdToCheck]) return;

            const challengeCategoryIds = categories.filter(c => c.isChallenge).map(c => c.id);
            if (challengeCategoryIds.length === 0) return; // Tidak ada tantangan aktif

            const hasSpentOnChallenge = allTransactions.some(t => {
                const tDate = new Date(t.date);
                return tDate >= startOfWeek && tDate <= endOfWeek && challengeCategoryIds.includes(t.category);
            });

            if (!hasSpentOnChallenge) {
                // Misi berhasil diselesaikan
                updates[`completedQuests.${questIdToCheck}`] = true;
                updates.xp = increment(quest.xp);
                showNotificationModal('Misi Tantangan Selesai!', 'military_tech', `Selamat! Anda berhasil menyelesaikan "${quest.text}" dan mendapatkan <strong>+${quest.xp} XP</strong>`, 'green');
            }
        }
        
        // PERBAIKAN: Fungsi penalti dibuat lebih aman dengan transaksi dan lebih rapi.
        async function checkForMissedQuestsAndApplyPenalties() {
            if (!isInitialLoadComplete || !userProfile.lastPenaltyCheck) {
                await updateDoc(doc(db, `users/${userId}/profile/main`), { lastPenaltyCheck: serverTimestamp() });
                return;
            }

            const now = new Date();
            const lastCheckDate = userProfile.lastPenaltyCheck instanceof Timestamp
                                ? userProfile.lastPenaltyCheck.toDate() 
                                : new Date();
            
            const profileRef = doc(db, `users/${userId}/profile/main`);

            try {
                await runTransaction(db, async (transaction) => {
                    // Baca profil terbaru di dalam transaksi untuk menghindari race condition
                    const freshProfileSnap = await transaction.get(profileRef);
                    if (!freshProfileSnap.exists()) throw "Profil tidak ditemukan.";
                    const freshUserProfile = freshProfileSnap.data();

                    const updates = {};
                    let totalXpPenalty = 0;
                    let failedQuestsCount = 0;
                    
                    const questsToEvaluate = allQuests.filter(q => q.recurring && !q.noPenalty);

                    // Iterasi setiap hari sejak pengecekan terakhir
                    for (let d = new Date(lastCheckDate); d < now; d.setDate(d.getDate() + 1)) {
                        if (d.toDateString() === now.toDateString()) continue;
                        
                        const dayInLoop = new Date(d);
                        const [year, week] = getWeekNumber(dayInLoop);
                        const weekKey = `${year}-W${week}`;
                        const monthKey = `${dayInLoop.getFullYear()}-${dayInLoop.getMonth()}`;

                        // Saat akhir minggu
                        if (dayInLoop.getDay() === 0) {
                            // PERBAIKAN: Logika evaluasi misi mingguan dipanggil di sini
                            const startOfWeek = new Date(dayInLoop);
                            startOfWeek.setDate(dayInLoop.getDate() - 6);
                            startOfWeek.setHours(0,0,0,0);
                            await evaluateWeeklyQuests(weekKey, startOfWeek, dayInLoop, updates);

                            for (const quest of questsToEvaluate.filter(q => q.category === 'Misi Mingguan')) {
                                const questIdToCheck = `${quest.id}_${weekKey}`;
                                if (!freshUserProfile.completedQuests[questIdToCheck] && !freshUserProfile.failedQuests[questIdToCheck]) {
                                    updates[`failedQuests.${questIdToCheck}`] = true;
                                    totalXpPenalty += Math.floor(quest.xp / 2);
                                    failedQuestsCount++;
                                }
                            }
                        }

                        // Saat akhir bulan
                        if (dayInLoop.getDate() === new Date(dayInLoop.getFullYear(), dayInLoop.getMonth() + 1, 0).getDate()) {
                            for (const quest of questsToEvaluate.filter(q => q.category === 'Misi Bulanan')) {
                                const questIdToCheck = `${quest.id}_${monthKey}`;
                                if (!freshUserProfile.completedQuests[questIdToCheck] && !freshUserProfile.failedQuests[questIdToCheck]) {
                                    updates[`failedQuests.${questIdToCheck}`] = true;
                                    totalXpPenalty += Math.floor(quest.xp / 2);
                                    failedQuestsCount++;
                                }
                            }
                        }
                    }

                    // Hukuman tambahan
                    for (let i = 0; i < failedQuestsCount; i++) {
                        if (Math.random() < 0.10) { // Peluang 10%
                            const inventory = freshUserProfile.inventory || {};
                            const availableCards = Object.keys(inventory).filter(k => inventory[k] > 0 && k !== 'exp_boost_x2' && k !== 'penalty_negation');
                            if (inventory.penalty_negation > 0) {
                                updates['inventory.penalty_negation'] = increment(-1);
                                showNotificationModal('Hukuman Dibatalkan!', 'shield', 'Kartu Tolak Hukuman telah digunakan untuk membatalkan satu penalti.', 'amber');
                                totalXpPenalty -= 50; // Kurangi penalti XP jika ada
                                if (totalXpPenalty < 0) totalXpPenalty = 0;
                                continue;
                            } else if (availableCards.length > 0) {
                                const cardToRemove = availableCards[Math.floor(Math.random() * availableCards.length)];
                                updates[`inventory.${cardToRemove}`] = increment(-1);
                                showNotificationModal('Hukuman Tambahan!', 'gpp_bad', `Anda kurang beruntung! <strong>1x ${CARD_TYPES[cardToRemove].name}</strong> telah dihapus.`, 'red');
                            } else {
                                totalXpPenalty += 50;
                                showNotificationModal('Hukuman Tambahan!', 'gpp_bad', `Anda kurang beruntung dan tidak punya kartu! Kehilangan <strong>50 XP</strong> tambahan.`, 'red');
                            }
                        }
                    }

                    if (totalXpPenalty > 0) {
                        updates.xp = increment(-totalXpPenalty);
                        showNotificationModal('Hukuman!', 'gpp_bad', `Anda kehilangan total <strong>${totalXpPenalty} XP</strong> karena gagal menyelesaikan misi.`, 'red');
                    }
                    
                    // PERBAIKAN: Timestamp diperbarui di dalam transaksi
                    updates.lastPenaltyCheck = serverTimestamp();
                    if (Object.keys(updates).length > 1) {
                        transaction.update(profileRef, updates);
                    } else {
                        transaction.update(profileRef, { lastPenaltyCheck: serverTimestamp() });
                    }
                });
            } catch (error) {
                console.error("Gagal menerapkan penalti:", error);
                showError("Terjadi kesalahan saat memeriksa misi yang terlewat.");
            }
        }

        async function checkMissedLastMonthQuests() {
            const now = new Date();
            if (now.getDate() > 5) return; 

            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthYear = lastMonth.getFullYear();
            const lastMonthMonth = lastMonth.getMonth();
            const lastMonthKey = `${lastMonthYear}-${lastMonthMonth}`;
            
            const startOfLastMonth = new Date(lastMonthYear, lastMonthMonth, 1);
            const endOfLastMonth = new Date(lastMonthYear, lastMonthMonth + 1, 0);
            endOfLastMonth.setHours(23, 59, 59, 999);

            const lastMonthTxs = allTransactions.filter(t => {
                const d = new Date(t.date);
                return d >= startOfLastMonth && d <= endOfLastMonth;
            });

            if (lastMonthTxs.length === 0) return;

            const updates = {};
            let xpGained = 0;

            const monthlyQuests = allQuests.filter(q => q.category === 'Misi Bulanan' && q.recurring);

            for (const quest of monthlyQuests) {
                const questIdToCheck = `${quest.id}_${lastMonthKey}`;
                if (userProfile.completedQuests[questIdToCheck] || userProfile.failedQuests[questIdToCheck]) continue;

                let isCompleted = false;
                switch (quest.type) {
                    case 'log_transaction_monthly':
                        if (lastMonthTxs.length >= quest.target) isCompleted = true;
                        break;
                    case 'saving_rate':
                        const income = lastMonthTxs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                        const expenses = lastMonthTxs.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                        const savingRate = income > 0 ? ((income - expenses) / income) * 100 : 0;
                        if (savingRate >= quest.target) isCompleted = true;
                        break;
                }

                if (isCompleted) {
                    updates[`completedQuests.${questIdToCheck}`] = true;
                    xpGained += quest.xp;
                    showNotificationModal('Hadiah Ditemukan!', 'redeem', `Anda menyelesaikan misi "${quest.text}" bulan lalu dan mendapatkan <strong>+${quest.xp} XP</strong>!`, 'blue');
                }
            }
            
            if (xpGained > 0) {
                updates.xp = increment(xpGained);
                await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
            }
        }

        // PERBAIKAN: Fungsi pengingat pintar yang baru
        function renderSmartReminders() {
            const transactions = getTransactionsForMonth(currentDate);
            const reminderSection = el('smart-reminder-section');
            let unpaidBills = [];
            let overspentBudgets = [];

            categories.filter(cat => !cat.isArchived && cat.budget > 0).forEach(cat => {
                const spent = transactions
                    .filter(t => t.category === cat.id && t.type === 'expense')
                    .reduce((s, t) => s + t.amount, 0);

                const categoryType = cat.type || 'bill'; // Default ke 'bill' untuk data lama

                if (categoryType === 'bill' && spent < cat.budget) {
                    unpaidBills.push(cat.name);
                }

                if (categoryType === 'limit' && spent > cat.budget) {
                    overspentBudgets.push({
                        name: cat.name,
                        overage: spent - cat.budget
                    });
                }
            });

            let reminderHtml = '';

            if (unpaidBills.length > 0) {
                reminderHtml += `
                    <div class="bg-yellow-500/20 text-yellow-300 p-4 rounded-lg flex items-start gap-4">
                        <i data-lucide="info" class="w-6 h-6 flex-shrink-0 mt-1"></i>
                        <div>
                            <h3 class="font-bold">Pengingat Tagihan</h3>
                            <p class="text-sm">Tagihan berikut tampaknya belum lunas: <strong>${unpaidBills.join(', ')}</strong>.</p>
                        </div>
                    </div>`;
            }

            if (overspentBudgets.length > 0) {
                reminderHtml += overspentBudgets.map(item => `
                    <div class="bg-red-500/20 text-red-300 p-4 rounded-lg flex items-start gap-4">
                        <i data-lucide="alert-triangle" class="w-6 h-6 flex-shrink-0 mt-1"></i>
                        <div>
                            <h3 class="font-bold">Peringatan Anggaran Terlampaui!</h3>
                            <p class="text-sm">Anda telah melebihi anggaran untuk <strong>${item.name}</strong> sebesar <strong>${formatCurrency(item.overage)}</strong>.</p>
                        </div>
                    </div>`
                ).join('');
            }

            reminderSection.innerHTML = reminderHtml;

            if (reminderHtml) {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }
        
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalContent = button.innerHTML;
                button.innerHTML = '<div class="spinner"></div>';
            } else {
                button.disabled = false;
                if(button.dataset.originalContent) {
                    button.innerHTML = button.dataset.originalContent;
                }
            }
        }

        function openModal(modal, focusSelector = 'input, select') {
            modal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
            setTimeout(() => {
                const focusableElement = modal.querySelector(focusSelector);
                if (focusableElement) focusableElement.focus();
            }, 50);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function closeModal(modalElement = null) {
            if (modalElement) {
                modalElement.classList.add('hidden');
            } else {
                document.querySelectorAll('.fixed.z-50').forEach(m => m.classList.add('hidden'));
            }

            const anyModalVisible = document.querySelector('.fixed.z-50:not(.hidden)');
            if (!anyModalVisible) {
                modalBackdrop.classList.add('hidden');
            }
        }

        modalBackdrop.addEventListener('click', () => closeModal());
        
        function showNotificationModal(title, icon, message, color) {
            notificationQueue.push({ title, icon, message, color });
            if (!isNotificationShowing) {
                processNotificationQueue();
            }
        }

        function processNotificationQueue() {
            if (notificationQueue.length > 0 && !isNotificationShowing) {
                isNotificationShowing = true;
                const notification = notificationQueue.shift();
                const colors = { green: 'text-green-400', blue: 'text-blue-400', amber: 'text-amber-400', red: 'text-red-400', violet: 'text-violet-400' };
                notificationModal.innerHTML = `
                    <div class="flex justify-center items-center mb-4"><span class="material-symbols-outlined ${colors[notification.color] || 'text-slate-300'}" style="font-size: 48px;">${notification.icon}</span></div>
                    <h3 class="text-xl font-bold mb-2 ${colors[notification.color] || 'text-slate-200'}">${notification.title}</h3>
                    <p class="text-slate-300 mb-6">${notification.message}</p>
                    <div class="flex justify-end"><button id="notification-ok-btn" class="btn btn-secondary">OK</button></div>`;
                openModal(notificationModal, '#notification-ok-btn');
                el('notification-ok-btn').onclick = () => {
                    closeModal(notificationModal);
                    isNotificationShowing = false;
                    setTimeout(processNotificationQueue, 300);
                };
            }
        }

        function showConfirmation(message) {
            return new Promise((resolve) => {
                confirmModal.innerHTML = `
                    <p class="text-slate-200 mb-6">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-cancel" class="btn bg-slate-600 hover:bg-slate-500">Batal</button>
                        <button id="confirm-ok" class="btn btn-danger">Ya</button>
                    </div>`;
                openModal(confirmModal, '#confirm-ok');
                el('confirm-ok').onclick = () => { closeModal(confirmModal); resolve(true); };
                el('confirm-cancel').onclick = () => { closeModal(confirmModal); resolve(false); };
            });
        }
        
        function renderInventory() {
            const grid = el('inventory-grid');
            const inventory = userProfile.inventory || {};
            const availableCards = Object.keys(inventory).filter(id => inventory[id] > 0);
            if (availableCards.length === 0) {
                grid.innerHTML = `<p class="text-slate-400 col-span-full text-center py-8">Inventarismu kosong.</p>`;
                return;
            }
            grid.innerHTML = availableCards.map(cardId => {
                const cardInfo = CARD_TYPES[cardId];
                return `
                    <div class="inventory-card" data-card-id="${cardId}">
                        <p class="card-name">${cardInfo.name}</p>
                        <div class="card-icon ${cardInfo.iconColor}"><span class="material-symbols-outlined">${cardInfo.icon}</span></div>
                        <div class="card-footer ${cardInfo.footerColor}"></div>
                        <div class="card-count">${inventory[cardId]}</div>
                    </div>`;
            }).join('');
        }

        async function showCardUseConfirmation(cardId) {
            const cardInfo = CARD_TYPES[cardId];

            if (cardId === 'exp_boost_x2' && userProfile.activeBoosts?.exp_boost_x2_until > Date.now()) {
                const confirmed = await showConfirmation(
                    `Anda sudah memiliki XP Boost yang aktif. Menggunakan kartu ini akan me-reset durasi boost menjadi 1 bulan dari sekarang. Apakah Anda yakin ingin melanjutkan?`
                );
                if (confirmed) {
                    useCard(cardId);
                }
                return;
            }

            const useAllButtonHtml = cardId === 'xp_bonus' && userProfile.inventory.xp_bonus > 1
                ? `<button id="confirm-use-all-card-btn" data-card-id="${cardId}" class="btn btn-secondary">Gunakan Semua (${userProfile.inventory.xp_bonus})</button>`
                : '';

            cardUseConfirmModal.innerHTML = `
                <p class="text-lg font-bold text-slate-200 mb-2">${cardInfo.name}</p>
                <div class="card-icon ${cardInfo.iconColor} my-4"><span class="material-symbols-outlined" style="font-size: 80px;">${cardInfo.icon}</span></div>
                <p class="text-slate-300 mb-6">${cardInfo.description}</p>
                <div class="flex flex-wrap justify-center gap-3">
                    <button id="cancel-use-card-btn" class="btn bg-slate-600 hover:bg-slate-500">Batal</button>
                    <button id="confirm-use-card-btn" data-card-id="${cardId}" class="btn btn-primary">Gunakan</button>
                    ${useAllButtonHtml}
                </div>`;
            openModal(cardUseConfirmModal, '#confirm-use-card-btn');
        }

        async function useCard(cardId) {
            const updates = {};
            if (!userProfile.inventory[cardId] || userProfile.inventory[cardId] <= 0) {
                showNotificationModal('Gagal Menggunakan Kartu', 'error', 'Anda tidak memiliki kartu ini.', 'red');
                return;
            }

            switch (cardId) {
                case 'xp_bonus':
                    closeModal(cardUseConfirmModal);
                    let xpFromCard = 100;
                    let notificationMessage = `Anda mendapatkan <strong>+${xpFromCard} XP</strong>!`;
                    if (userProfile.activeBoosts?.exp_boost_x2_until > Date.now()) {
                        xpFromCard *= 2;
                        notificationMessage = `XP Boost Aktif! Anda mendapatkan <strong>+${xpFromCard} XP</strong>!`;
                    }
                    updates[`inventory.${cardId}`] = increment(-1);
                    updates.xp = increment(xpFromCard);
                    showNotificationModal('Kartu Digunakan!', 'stars', notificationMessage, 'blue');
                    break;
                
                case 'skip_weekly': 
                    closeModal(cardUseConfirmModal);
                    showSkipQuestModal('weekly'); 
                    return;
                case 'skip_monthly': 
                    closeModal(cardUseConfirmModal);
                    showSkipQuestModal('monthly'); 
                    return;

                case 'exp_boost_x2':
                    closeModal(cardUseConfirmModal);
                    updates[`inventory.${cardId}`] = increment(-1);
                    const oneMonth = new Date(); oneMonth.setMonth(oneMonth.getMonth() + 1);
                    updates['activeBoosts.exp_boost_x2_until'] = oneMonth.getTime();
                    updates['boostExpiryNotified'] = false;
                    showNotificationModal('XP Boost Aktif!', 'rocket_launch', 'Semua XP akan digandakan selama <strong>1 bulan</strong>!', 'violet');
                    break;
            }
            if (Object.keys(updates).length > 0) {
                await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
                renderInventory();
            }
        }
        
        async function useAllXpBonusCards() {
            closeModal(cardUseConfirmModal);
            const cardId = 'xp_bonus';
            const cardCount = userProfile.inventory[cardId] || 0;

            if (cardCount <= 0) {
                showNotificationModal('Gagal', 'error', 'Anda tidak memiliki kartu ini.', 'red');
                return;
            }

            const updates = {};
            let xpFromCards = 100 * cardCount;
            let notificationMessage = `Anda menggunakan ${cardCount} kartu dan mendapatkan <strong>+${xpFromCards} XP</strong>!`;

            if (userProfile.activeBoosts?.exp_boost_x2_until > Date.now()) {
                xpFromCards *= 2;
                notificationMessage = `XP Boost Aktif! Anda menggunakan ${cardCount} kartu dan mendapatkan <strong>+${xpFromCards} XP</strong>!`;
            }

            updates[`inventory.${cardId}`] = increment(-cardCount);
            updates.xp = increment(xpFromCards);

            try {
                await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
                showNotificationModal('Semua Kartu Digunakan!', 'stars', notificationMessage, 'blue');
                renderInventory();
            } catch (error) {
                console.error("Error using all cards:", error);
                showError("Gagal menggunakan semua kartu.");
            }
        }

        function showSkipQuestModal(type) {
            const now = new Date();
            const periodKey = type === 'weekly' 
                ? `${getWeekNumber(now)[0]}-W${getWeekNumber(now)[1]}`
                : `${now.getFullYear()}-${now.getMonth()}`;
            const missionCategory = type === 'weekly' ? 'Misi Mingguan' : 'Misi Bulanan';

            const skippable = allQuests.filter(q => 
                q.category === missionCategory && 
                !userProfile.completedQuests[`${q.id}_${periodKey}`] && 
                !userProfile.failedQuests[`${q.id}_${periodKey}`]
            );
            
            skipQuestModal.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-green-400">Pilih Misi untuk Dilewati</h2>
                    <button id="close-skip-quest-btn" class="text-slate-400 hover:text-white">&times;</button>
                </div>
                <div id="skip-quest-list" class="space-y-3 max-h-[60vh] overflow-y-auto">
                    ${skippable.length === 0 
                        ? `<p class="text-slate-400 text-center py-4">Tidak ada misi ${type === 'weekly' ? 'mingguan' : 'bulanan'} yang bisa dilewati.</p>`
                        : skippable.map(q => `
                            <button class="btn bg-slate-700 hover:bg-slate-600 w-full text-left" data-quest-id="${q.id}" data-quest-type="${type}">
                                <div class="flex-1"><p class="font-semibold">${q.text}</p><p class="text-sm text-green-400">+${q.xp} XP</p></div>
                                <i data-lucide="chevrons-right"></i>
                            </button>`).join('')
                    }
                </div>
            `;
            openModal(skipQuestModal);
            el('close-skip-quest-btn').addEventListener('click', () => closeModal(skipQuestModal));
        }
        
        async function skipQuest(questId, type) {
            closeModal(skipQuestModal);
            const cardId = `skip_${type}`;
            if (!userProfile.inventory[cardId] || userProfile.inventory[cardId] <= 0) {
                showNotificationModal('Gagal Menggunakan Kartu', 'error', 'Anda tidak memiliki kartu ini.', 'red');
                return;
            }

            const quest = allQuests.find(q => q.id === questId);
            if (!quest) return;

            let questIdToCheck = quest.id;
            const now = new Date();
            if (quest.category === 'Misi Harian') questIdToCheck = `${quest.id}_${now.toISOString().split('T')[0]}`;
            else if (quest.category === 'Misi Mingguan') {
                const [year, week] = getWeekNumber(now);
                questIdToCheck = `${quest.id}_${year}-W${week}`;
            } else if (quest.category === 'Misi Bulanan') {
                questIdToCheck = `${quest.id}_${now.getFullYear()}-${now.getMonth()}`;
            }

            if (userProfile.completedQuests[questIdToCheck]) {
                showNotificationModal('Misi Sudah Selesai', 'info', `Misi "${quest.text}" sudah Anda selesaikan.`, 'blue');
                return;
            }

            const updates = {};
            let xpGained = quest.xp;
            let cardsToAward = {}; 

            if (userProfile.activeBoosts?.exp_boost_x2_until > Date.now()) {
                xpGained *= 2;
            }
            updates.xp = increment(xpGained);
            updates[`completedQuests.${questIdToCheck}`] = true;
            updates[`inventory.${cardId}`] = increment(-1);

            if (quest.guaranteedBoost) {
                cardsToAward['exp_boost_x2'] = (cardsToAward['exp_boost_x2'] || 0) + 1;
                showNotificationModal('Hadiah Spesial!', 'workspace_premium', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES['exp_boost_x2'].name}</strong>!`, 'violet');
            }
            if (quest.guaranteedReward) {
                for (let i = 0; i < quest.guaranteedReward; i++) {
                    const cardIdAward = getRandomCard(); 
                    cardsToAward[cardIdAward] = (cardsToAward[cardIdAward] || 0) + 1;
                    showNotificationModal('Hadiah Didapat!', 'card_giftcard', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES[cardIdAward].name}</strong>!`, 'blue');
                }
            } else if (userProfile.questRewards && userProfile.questRewards[questIdToCheck]) {
                const cardIdAward = getRandomCard(); 
                cardsToAward[cardIdAward] = (cardsToAward[cardIdAward] || 0) + 1;
                showNotificationModal('Beruntung!', 'auto_awesome', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES[cardIdAward].name}</strong>!`, 'blue');
            }
            
            for (const awardedCardId in cardsToAward) {
                updates[`inventory.${awardedCardId}`] = increment(cardsToAward[awardedCardId]);
            }

            try {
                await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
                showNotificationModal('Misi Dilewati!', 'check_circle', `Misi "${quest.text}" berhasil dilewati! Anda mendapatkan <strong>+${xpGained} XP</strong>!`, 'green');
                renderInventory();
            } catch (error) {
                console.error("Error skipping quest:", error);
                showError("Gagal melewati misi.");
            }
        }

        // PERBAIKAN: Handler form kategori disesuaikan untuk menyimpan 'type'
        el('category-form').addEventListener('submit', async (e) => {
            e.preventDefault(); hideError();
            const button = e.target.querySelector('button[type="submit"]');
            const name = el('category-name').value;
            const budget = el('category-budget').value;
            const type = el('category-type').value; // Ambil tipe kategori

            if (!name || !budget || Number(budget) < 0) return showError('Nama kategori dan anggaran positif harus diisi.');
            
            setButtonLoading(button, true);
            try {
                await addDoc(collection(db, `users/${userId}/categories`), { 
                    name: toTitleCase(name), 
                    budget: Number(budget), 
                    type: type, // Simpan tipe
                    isArchived: false, 
                    isChallenge: false 
                });
                checkAndCompleteQuests({ questId: 'q2' });
                el('category-form').reset();
                renderAll(); 
            } catch (err) { console.error(err); showError('Gagal menambah kategori.'); }
            finally { setButtonLoading(button, false); }
        });

        el('income-category-form').addEventListener('submit', async (e) => {
            e.preventDefault(); hideError();
            const button = e.target.querySelector('button[type="submit"]');
            const name = el('income-category-name').value;
            if (!name) return;

            setButtonLoading(button, true);
            try { 
                await addDoc(collection(db, `users/${userId}/income_categories`), { name: toTitleCase(name), isArchived: false }); 
                el('income-category-name').value = '';
                renderAll();
            } 
            catch (err) { console.error(err); showError('Gagal menambah kategori pemasukan.'); }
            finally { setButtonLoading(button, false); }
        });

        el('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError(); 
            const button = e.target.querySelector('button[type="submit"]');
            const description = el('transaction-description').value;
            const amount = el('transaction-amount').value;

            if (!description || !amount || Number(amount) <= 0) {
                return showError('Deskripsi dan jumlah positif tidak boleh kosong.');
            }

            setButtonLoading(button, true);
            try {
                const transactionData = {
                    description: toTitleCase(description),
                    amount: Number(amount),
                    type: el('transaction-type').value,
                    category: el('transaction-category').value,
                    date: serverTimestamp()
                };

                await addDoc(collection(db, `users/${userId}/transactions`), transactionData);

                checkAndCompleteQuests();
                el('transaction-description').value = '';
                el('transaction-amount').value = '';
                el('transaction-type').value = 'expense';
                renderTransactionCategoryDropdown();

            } catch (err) {
                console.error("Gagal menambah transaksi:", err);
                showError('Gagal menambah transaksi. Cek koneksi atau coba lagi.');
            } finally {
                setButtonLoading(button, false);
            }
        });

        el('transaction-type').addEventListener('change', renderTransactionCategoryDropdown);
        
        document.body.addEventListener('change', (e) => {
            const target = e.target;
            if (target.matches('.category-checkbox')) {
                target.checked ? selectedCategories.add(target.dataset.id) : selectedCategories.delete(target.dataset.id);
                renderCategories();
            } else if (target.matches('.income-category-checkbox')) {
                target.checked ? selectedIncomeCategories.add(target.dataset.id) : selectedIncomeCategories.delete(target.dataset.id);
                renderIncomeCategories();
            } else if (target.matches('.transaction-checkbox')) {
                target.checked ? selectedTransactions.add(target.dataset.id) : selectedTransactions.delete(target.dataset.id);
                 renderTransactions();
            } 
            else if (target.matches('.goal-checkbox')) {
                target.checked ? selectedGoals.add(target.dataset.id) : selectedGoals.delete(target.dataset.id);
                renderGoals();
            } else if (target.matches('.debt-checkbox')) {
                target.checked ? selectedDebts.add(target.dataset.id) : selectedDebts.delete(target.dataset.id);
                renderDebts();
            } else if (target.matches('.investment-checkbox')) {
                target.checked ? selectedInvestments.add(target.dataset.id) : selectedInvestments.delete(target.dataset.id);
                renderInvestments();
            }
            updateActionButtonsState();
        });

        async function handleCategoryDeletion(button, ids, type) {
            setButtonLoading(button, true);
            try {
                if (type === 'categories' && ids.has(activeFilters.category)) {
                    activeFilters.category = '';
                }
                const batch = writeBatch(db);
                ids.forEach(id => batch.update(doc(db, `users/${userId}/${type}/${id}`), { isArchived: true }));
                await batch.commit();
            } catch (err) { console.error(err); showError(`Gagal mengarsipkan.`); }
            finally { setButtonLoading(button, false); }
        }

        document.body.addEventListener('click', async (e) => {
            const target = e.target;
            const actionTarget = target.closest('[data-action]');
            if (target.closest('.quest-category-header')) {
                const header = target.closest('.quest-category-header');
                const content = header.nextElementSibling;
                if (content.style.maxHeight) content.style.maxHeight = null; else content.style.maxHeight = content.scrollHeight + "px";
                header.querySelector('.quest-arrow-right').classList.toggle('hidden');
                header.querySelector('.quest-arrow-down').classList.toggle('hidden');
            } else if (target.closest('.inventory-card')) {
                const cardId = target.closest('.inventory-card').dataset.cardId;
                if (cardId === 'penalty_negation') return showNotificationModal('Info Kartu', 'info', 'Kartu ini akan digunakan otomatis saat Anda terkena hukuman.', 'amber');
                await showCardUseConfirmation(cardId);
            } else if (target.closest('#skip-quest-list button')) {
                const button = target.closest('button');
                await skipQuest(button.dataset.questId, button.dataset.questType);
            } else if (target.id === 'confirm-use-card-btn') {
                await useCard(target.dataset.cardId);
            } else if (target.id === 'confirm-use-all-card-btn') {
                const cardId = target.dataset.cardId;
                if (cardId === 'xp_bonus') {
                    await useAllXpBonusCards();
                }
            } else if (target.id === 'close-game-guide-btn') {
                if (isInitialLoadComplete && !userProfile.hasReadGuide) {
                    const updates = { hasReadGuide: true };
                    const cardId = getRandomCard();
                    if (Math.random() < 0.5) {
                        updates.xp = increment(50);
                        showNotificationModal('Bonus Membaca!', 'school', `Terima kasih telah membaca panduan! Anda mendapatkan bonus <strong>50 XP</strong>!`, 'blue');
                    } else {
                        updates[`inventory.${cardId}`] = increment(1);
                        showNotificationModal('Bonus Membaca!', 'school', `Terima kasih telah membaca panduan! Anda mendapatkan bonus <strong>1x ${CARD_TYPES[cardId].name}</strong>!`, 'blue');
                    }
                    await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
                }
                closeModal(gameGuideModal);
            } else if (target.id === 'close-dashboard-guide-btn') {
                if (isInitialLoadComplete && !userProfile.hasReadDashboardGuide) {
                    const updates = { hasReadDashboardGuide: true };
                    const cardId = getRandomCard();
                    if (Math.random() < 0.5) {
                        updates.xp = increment(25);
                        showNotificationModal('Bonus Membaca!', 'school', `Terima kasih telah membaca panduan dasbor! Anda mendapatkan bonus <strong>25 XP</strong>!`, 'blue');
                    } else {
                        updates[`inventory.${cardId}`] = increment(1);
                        showNotificationModal('Bonus Membaca!', 'school', `Terima kasih telah membaca panduan dasbor! Anda mendapatkan bonus <strong>1x ${CARD_TYPES[cardId].name}</strong>!`, 'blue');
                    }
                    await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
                }
                closeModal(dashboardGuideModal);
            } else if (target.id === 'cancel-use-card-btn') {
                closeModal(cardUseConfirmModal);
            } else if (target.id === 'close-inventory-btn') {
                closeModal(inventoryModal);
            } else if (actionTarget) {
                const action = actionTarget.dataset.action;
                const id = actionTarget.dataset.id;
                if (action.startsWith('delete-selected')) {
                    const button = actionTarget;
                    let collectionName, selectedSet, itemType;

                    switch (action) {
                        case 'delete-selected':
                            collectionName = 'transactions';
                            selectedSet = selectedTransactions;
                            itemType = 'transaksi';
                            break;
                        case 'delete-selected-category':
                        case 'delete-selected-income-category':
                            break;
                        case 'delete-selected-goals':
                            collectionName = 'goals';
                            selectedSet = selectedGoals;
                            itemType = 'tujuan';
                            break;
                        case 'delete-selected-debts':
                            collectionName = 'debts';
                            selectedSet = selectedDebts;
                            itemType = 'catatan utang/piutang';
                            break;
                        case 'delete-selected-investments':
                            collectionName = 'investments';
                            selectedSet = selectedInvestments;
                            itemType = 'aset investasi';
                            break;
                    }

                    if (action.includes('category')) {
                        const selectedCatSet = action.includes('income') ? selectedIncomeCategories : selectedCategories;
                        if (selectedCatSet.size === 0) return;
                        const catType = action.includes('income') ? 'kategori pemasukan' : 'kategori';
                        if (await showConfirmation(`Anda yakin ingin mengarsipkan ${selectedCatSet.size} ${catType} yang dipilih?`)) {
                             await handleCategoryDeletion(button, selectedCatSet, action.includes('income') ? 'income_categories' : 'categories');
                             selectedCatSet.clear();
                        }
                    } else if (selectedSet && selectedSet.size > 0) {
                        if (await showConfirmation(`Anda yakin ingin menghapus ${selectedSet.size} ${itemType} yang dipilih?`)) {
                            setButtonLoading(button, true);
                            try {
                                const batch = writeBatch(db);
                                selectedSet.forEach(docId => batch.delete(doc(db, `users/${userId}/${collectionName}/${docId}`)));
                                await batch.commit();
                            } catch (err) { showError(`Gagal menghapus ${itemType}.`); console.error(err); } 
                            finally {
                                setButtonLoading(button, false);
                                selectedSet.clear();
                            }
                        }
                    }
                } else if (action === 'toggle-challenge') {
                    const category = categories.find(c => c.id === id);
                    if (!category) return;
                    const newStatus = !(category.isChallenge || false);
                    await updateDoc(doc(db, `users/${userId}/categories/${id}`), { isChallenge: newStatus });
                    category.isChallenge = newStatus;
                    renderCategories();
                    renderQuests();
                } 
                else if (action === 'edit-goal') {
                    const goal = financialGoals.find(g => g.id === id);
                    if (!goal) return;
                    editGoalModal.innerHTML = `
                        <form id="edit-goal-form">
                            <h3 class="text-xl font-bold mb-4">Edit Tujuan Keuangan</h3>
                            <input type="text" id="edit-goal-name" value="${goal.name}" class="input-field mb-3" required>
                            <input type="number" id="edit-goal-target" value="${goal.targetAmount}" class="input-field mb-3" min="0" required>
                            <input type="date" id="edit-goal-date" value="${new Date(goal.targetDate).toISOString().split('T')[0]}" class="input-field" required>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="btn-cancel-modal btn bg-slate-600">Batal</button>
                                <button type="submit" class="btn btn-primary">Perbarui</button>
                            </div>
                        </form>`;
                    openModal(editGoalModal);
                    editGoalModal.querySelector('.btn-cancel-modal').onclick = () => closeModal(editGoalModal);
                    editGoalModal.querySelector('#edit-goal-form').onsubmit = async (ev) => {
                        ev.preventDefault();
                        const updatedGoal = {
                            name: toTitleCase(editGoalModal.querySelector('#edit-goal-name').value),
                            targetAmount: Number(editGoalModal.querySelector('#edit-goal-target').value),
                            targetDate: editGoalModal.querySelector('#edit-goal-date').value
                        };
                        await updateDoc(doc(db, `users/${userId}/goals/${id}`), updatedGoal);
                        closeModal(editGoalModal);
                    };
                }
                else if (action === 'edit-investment') {
                    const investment = investments.find(i => i.id === id);
                    if (!investment) return;
                    editInvestmentModal.innerHTML = `
                        <form id="edit-investment-form">
                            <h3 class="text-xl font-bold mb-4">Edit Aset Investasi</h3>
                             <input type="text" id="edit-inv-name" value="${investment.name}" class="input-field mb-3" required>
                            <input type="number" id="edit-inv-units" value="${investment.units}" class="input-field mb-3" min="0" step="any" required>
                             <input type="number" id="edit-inv-avg-price" value="${investment.avgPrice}" class="input-field mb-3" min="0" required>
                             <label for="edit-inv-current-price" class="text-sm text-slate-300">Harga Kini (Per Unit)</label>
                            <input type="number" id="edit-inv-current-price" value="${investment.currentPrice || investment.avgPrice}" class="input-field" min="0" required>
                            <p class="text-xs text-slate-400 mt-1">Perbarui harga pasar aset saat ini di sini.</p>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="btn-cancel-modal btn bg-slate-600">Batal</button>
                                <button type="submit" class="btn btn-primary">Perbarui</button>
                            </div>
                        </form>`;
                    openModal(editInvestmentModal);
                    editInvestmentModal.querySelector('.btn-cancel-modal').onclick = () => closeModal(editInvestmentModal);
                    editInvestmentModal.querySelector('#edit-investment-form').onsubmit = async (ev) => {
                        ev.preventDefault();
                        const updatedInvestment = {
                            name: toTitleCase(editInvestmentModal.querySelector('#edit-inv-name').value),
                            units: Number(editInvestmentModal.querySelector('#edit-inv-units').value),
                            avgPrice: Number(editInvestmentModal.querySelector('#edit-inv-avg-price').value),
                            currentPrice: Number(editInvestmentModal.querySelector('#edit-inv-current-price').value)
                        };
                        await updateDoc(doc(db, `users/${userId}/investments/${id}`), updatedInvestment);
                        closeModal(editInvestmentModal);
                    };
                }
                else if (action.startsWith('edit-')) {
                    const isCat = action.includes('category');
                    const isIncome = action.includes('income');
                    const modal = isIncome ? editIncomeCategoryModal : (isCat ? editCategoryModal : editTransactionModal);
                    const collectionName = isIncome ? 'income_categories' : (isCat ? 'categories' : 'transactions');
                    const docRef = doc(db, `users/${userId}/${collectionName}/${id}`);
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) return showError("Gagal: Item ini mungkin telah dihapus.");
                    const item = docSnap.data();

                    if (isCat) {
                        // PERBAIKAN: Modal edit kategori ditambahkan pilihan Tipe Anggaran
                        modal.innerHTML = `
                            <form id="edit-form" class="space-y-4">
                                <h3 class="text-xl font-bold mb-4">Edit Kategori${isIncome ? ' Pemasukan' : ''}</h3>
                                <input type="text" id="edit-cat-name" value="${item.name}" class="input-field" required>
                                ${!isIncome ? `
                                <div>
                                    <input type="number" id="edit-cat-budget" value="${item.budget}" class="input-field" min="0" required>
                                </div>
                                <div>
                                    <label for="edit-cat-type" class="text-sm text-slate-300">Tipe Kategori</label>
                                    <select id="edit-cat-type" class="input-field mt-1">
                                        <option value="bill">Tagihan</option>
                                        <option value="limit">Batas Belanja</option>
                                    </select>
                                </div>
                                ` : ''}
                                <div class="mt-6 flex justify-end gap-3"><button type="button" class="btn-cancel-modal btn bg-slate-600">Batal</button><button type="submit" class="btn btn-primary">Perbarui</button></div>
                            </form>`;
                        if (!isIncome) {
                            modal.querySelector('#edit-cat-type').value = item.type || 'bill'; // Set nilai default
                        }
                    } else { // Edit transaction
                        modal.innerHTML = `
                            <form id="edit-form">
                                <h3 class="text-xl font-bold mb-4">Edit Transaksi</h3>
                                <input type="text" id="edit-tx-desc" value="${item.description}" class="input-field mb-3" required>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <input type="number" id="edit-tx-amount" value="${item.amount}" class="input-field" min="0" required>
                                    <select id="edit-tx-type" class="input-field"><option value="expense">Pengeluaran</option><option value="income">Pemasukan</option></select>
                                    <select id="edit-tx-cat" class="input-field"></select>
                                </div>
                                <div class="mt-6 flex justify-end gap-3"><button type="button" class="btn-cancel-modal btn bg-slate-600">Batal</button><button type="submit" class="btn btn-secondary">Perbarui</button></div>
                            </form>`;
                        const typeDropdown = modal.querySelector('#edit-tx-type');
                        const catDropdown = modal.querySelector('#edit-tx-cat');
                        const populate = () => {
                            const list = typeDropdown.value === 'income' ? incomeCategories : categories;
                            catDropdown.innerHTML = '<option value="">Pilih Kategori...</option>' + list.filter(c => !c.isArchived).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                        };
                        typeDropdown.value = item.type;
                        populate();
                        catDropdown.value = item.category;
                        typeDropdown.addEventListener('change', populate);
                    }
                    
                    openModal(modal);

                    modal.querySelector('.btn-cancel-modal').addEventListener('click', () => closeModal(modal));

                    modal.querySelector('#edit-form').addEventListener('submit', async (ev) => {
                        ev.preventDefault();
                        const submitButton = ev.target.querySelector('button[type="submit"]');
                        setButtonLoading(submitButton, true);
                        try {
                            let updateData = {};
                            if (isCat) {
                                const newName = modal.querySelector('#edit-cat-name').value;
                                if (!newName) throw new Error("Nama tidak boleh kosong.");
                                updateData.name = toTitleCase(newName);
                                if (!isIncome) {
                                    const newBudget = modal.querySelector('#edit-cat-budget').value;
                                    const newType = modal.querySelector('#edit-cat-type').value;
                                    if (!newBudget || Number(newBudget) < 0) throw new Error("Anggaran tidak valid.");
                                    updateData.budget = Number(newBudget);
                                    updateData.type = newType;
                                }
                            } else {
                                const newDesc = modal.querySelector('#edit-tx-desc').value;
                                const newAmount = modal.querySelector('#edit-tx-amount').value;
                                if (!newDesc || !newAmount || Number(newAmount) < 0) throw new Error("Data tidak valid.");
                                updateData = {
                                    description: toTitleCase(newDesc),
                                    amount: Number(newAmount),
                                    type: modal.querySelector('#edit-tx-type').value,
                                    category: modal.querySelector('#edit-tx-cat').value
                                };
                            }
                            await updateDoc(docRef, updateData);
                            closeModal(modal);
                        } catch (err) { showError("Gagal memperbarui: " + err.message); }
                        finally { setButtonLoading(submitButton, false); }
                    });
                } else if (action === 'complete-quest') {
                    const quest = allQuests.find(q => q.id === id);
                    if (!quest) return;

                    let questIdToCheck = quest.id;
                    const now = new Date();
                    if (quest.recurring) {
                        if (quest.category === 'Misi Harian') questIdToCheck = `${quest.id}_${now.toISOString().split('T')[0]}`;
                        else if (quest.category === 'Misi Mingguan') {
                            const [year, week] = getWeekNumber(now);
                            questIdToCheck = `${quest.id}_${year}-W${week}`;
                        } else if (quest.category === 'Misi Bulanan') {
                            questIdToCheck = `${quest.id}_${now.getFullYear()}-${now.getMonth()}`;
                        }
                    }

                    if (userProfile.completedQuests[questIdToCheck]) {
                        showNotificationModal('Misi Sudah Selesai', 'info', `Misi "${quest.text}" sudah Anda selesaikan.`, 'blue');
                        return;
                    }

                    if (await showConfirmation(`Selesaikan misi "${quest.text}"?`)) {
                        const updates = {};
                        let xpGained = quest.xp;
                        let cardsToAward = {};

                        if (userProfile.activeBoosts?.exp_boost_x2_until > Date.now()) {
                            xpGained *= 2;
                        }
                        updates.xp = increment(xpGained);
                        updates[`completedQuests.${questIdToCheck}`] = true;

                        if (quest.guaranteedBoost) {
                            cardsToAward['exp_boost_x2'] = (cardsToAward['exp_boost_x2'] || 0) + 1;
                            showNotificationModal('Hadiah Spesial!', 'workspace_premium', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES['exp_boost_x2'].name}</strong>!`, 'violet');
                        }
                        if (quest.guaranteedReward) {
                            for (let i = 0; i < quest.guaranteedReward; i++) {
                                const cardIdAward = getRandomCard();
                                cardsToAward[cardIdAward] = (cardsToAward[cardIdAward] || 0) + 1;
                                showNotificationModal('Hadiah Didapat!', 'card_giftcard', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES[cardIdAward].name}</strong>!`, 'blue');
                            }
                        } else if (userProfile.questRewards && userProfile.questRewards[questIdToCheck]) {
                            const cardIdAward = getRandomCard();
                            cardsToAward[cardIdAward] = (cardsToAward[cardIdAward] || 0) + 1;
                            showNotificationModal('Beruntung!', 'auto_awesome', `Anda mendapatkan hadiah: <strong>1x ${CARD_TYPES[cardIdAward].name}</strong>!`, 'blue');
                        }
                        
                        for (const cardIdAward in cardsToAward) {
                            // Variabel sudah diperbaiki
                            updates[`inventory.${cardIdAward}`] = increment(cardsToAward[cardIdAward]);
                        }

                        try {
                            await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
                            // Sekarang notifikasi ini akan muncul dengan benar
                            showNotificationModal('Misi Selesai!', 'military_tech', `Anda menyelesaikan "${quest.text}" dan mendapatkan <strong>+${xpGained} XP</strong>`, 'green');
                        } catch (error) {
                            console.error("Error completing manual quest:", error);
                            showError("Gagal menyelesaikan misi manual.");
                        }
                    }
                }
                else if (action === 'add-funds-goal') {
                    addFundsGoalModal.innerHTML = `
                        <form id="add-funds-form">
                            <h3 class="text-xl font-bold mb-4">Tambah Dana ke Tujuan</h3>
                            <input type="number" id="add-funds-amount" placeholder="Jumlah Dana" class="input-field" min="0" required>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="btn-cancel-modal btn bg-slate-600">Batal</button>
                                <button type="submit" class="btn btn-primary">Tambah</button>
                            </div>
                        </form>`;
                    openModal(addFundsGoalModal);
                    addFundsGoalModal.querySelector('.btn-cancel-modal').onclick = () => closeModal(addFundsGoalModal);
                    addFundsGoalModal.querySelector('#add-funds-form').onsubmit = async (ev) => {
                        ev.preventDefault();
                        const amount = Number(addFundsGoalModal.querySelector('#add-funds-amount').value);
                        if (amount > 0) {
                            const goalRef = doc(db, `users/${userId}/goals/${id}`);
                            await updateDoc(goalRef, { currentAmount: increment(amount) });
                            await checkGoalCompletion(id);
                        }
                        closeModal(addFundsGoalModal);
                    };
                }
                else if (action === 'toggle-debt-paid') {
                    const debt = debts.find(d => d.id === id);
                    if (debt) {
                        await updateDoc(doc(db, `users/${userId}/debts/${id}`), { isPaid: !debt.isPaid });
                    }
                }
            }
        });

        async function createNewUserProfile() {
            if (isCreatingProfile) return;
            isCreatingProfile = true;
            const profileRef = doc(db, `users/${userId}/profile/main`);
            try {
                let newProfile = { level: 1, xp: 0, completedQuests: {}, failedQuests: {}, inventory: {}, activeBoosts: {}, lastPenaltyCheck: serverTimestamp(), hasReadGuide: false, hasReadDashboardGuide: false, boostExpiryNotified: false, questRewards: {} };
                
                await runTransaction(db, async (transaction) => {
                    const profileDoc = await transaction.get(profileRef);
                    if (!profileDoc.exists()) {
                        const card1 = getRandomCard(), card2 = getRandomCard();
                        newProfile.inventory[card1] = (newProfile.inventory[card1] || 0) + 1;
                        newProfile.inventory[card2] = (newProfile.inventory[card2] || 0) + 1;
                        transaction.set(profileRef, newProfile);
                        setTimeout(() => showNotificationModal('Starter Pack!', 'card_giftcard', `Selamat datang! Anda mendapatkan: <strong>1x ${CARD_TYPES[card1].name}</strong>`, 'blue'), 500);
                        setTimeout(() => showNotificationModal('Starter Pack!', 'card_giftcard', `Anda juga mendapatkan: <strong>1x ${CARD_TYPES[card2].name}</strong>`, 'blue'), 1500);
                    }
                });
                return newProfile;
            } catch (e) { 
                console.error("Transaction failed: ", e); 
                showError("Gagal membuat profil baru."); 
                return null;
            } finally { 
                isCreatingProfile = false; 
            }
        }

        function buildCategoryMap() {
            categoryMap = {};
            [...categories, ...incomeCategories].forEach(cat => {
                if (cat && cat.id) {
                    categoryMap[cat.id] = cat.name;
                }
            });
        }
        
        async function checkAndAssignQuestRewards() {
            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];
            const [year, week] = getWeekNumber(now);
            const weekKey = `${year}-W${week}`;
            const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
            
            const updates = {};
            if (!userProfile.questRewards) {
                userProfile.questRewards = {};
            }

            const recurringQuestsWithChance = allQuests.filter(q => q.recurring && q.rewardChance);

            for (const quest of recurringQuestsWithChance) {
                let questIdToCheck;
                if (quest.category === 'Misi Harian') questIdToCheck = `${quest.id}_${dateKey}`;
                else if (quest.category === 'Misi Mingguan') questIdToCheck = `${quest.id}_${weekKey}`;
                else questIdToCheck = `${quest.id}_${monthKey}`;

                if (userProfile.questRewards[questIdToCheck] === undefined) {
                    const hasReward = Math.random() < quest.rewardChance;
                    updates[`questRewards.${questIdToCheck}`] = hasReward;
                }
            }

            if (Object.keys(updates).length > 0) {
                await updateDoc(doc(db, `users/${userId}/profile/main`), updates);
            }
        }


        async function initializeAndLoadData() {
            console.log("Initializing for user:", userId);
            listeners.forEach(unsub => unsub());
            listeners = [];
            try {
                const profileRef = doc(db, `users/${userId}/profile/main`);
                let profileData;

                const profileSnap = await getDoc(profileRef);
                if (!profileSnap.exists()) {
                    const newProfileData = await createNewUserProfile();
                    if (newProfileData) {
                        profileData = newProfileData;
                    } else {
                        throw new Error("Failed to create user profile.");
                    }
                } else {
                    profileData = profileSnap.data();
                }
                
                userProfile = { 
                    level: 1, xp: 0, completedQuests: {}, failedQuests: {}, 
                    inventory: {}, activeBoosts: {}, lastPenaltyCheck: null, 
                    hasReadGuide: false, hasReadDashboardGuide: false, 
                    boostExpiryNotified: false, questRewards: {}, ...profileData
                };

                if (!userProfile.lastPenaltyCheck || !(userProfile.lastPenaltyCheck instanceof Timestamp)) {
                    await updateDoc(profileRef, { lastPenaltyCheck: serverTimestamp() });
                    const updatedProfileSnap = await getDoc(profileRef);
                    if (updatedProfileSnap.exists()) {
                        userProfile.lastPenaltyCheck = updatedProfileSnap.data().lastPenaltyCheck;
                    }
                }

                const [transactionsSnap, categoriesSnap, incomeCategoriesSnap, goalsSnap, debtsSnap, investmentsSnap] = await Promise.all([
                    getDocs(collection(db, `users/${userId}/transactions`)),
                    getDocs(collection(db, `users/${userId}/categories`)),
                    getDocs(collection(db, `users/${userId}/income_categories`)),
                    getDocs(collection(db, `users/${userId}/goals`)),
                    getDocs(collection(db, `users/${userId}/debts`)),
                    getDocs(collection(db, `users/${userId}/investments`))
                ]);
                allTransactions = transactionsSnap.docs.map(d => {
                    const data = d.data();
                    // Konversi Firestore Timestamp ke Javascript Date object di sini
                    const date = data.date && data.date.toDate ? data.date.toDate() : new Date();
                    return { id: d.id, ...data, date: date };
                });
                categories = categoriesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                incomeCategories = incomeCategoriesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                financialGoals = goalsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                debts = debtsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                investments = investmentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                buildCategoryMap();

                isInitialLoadComplete = true;
                console.log("Initial data loaded. Rendering UI.");
                
                await checkAndAssignQuestRewards();
                // PERBAIKAN: Fungsi penalti dan evaluasi dipanggil saat inisialisasi
                await checkForMissedQuestsAndApplyPenalties();
                await checkMissedLastMonthQuests(); 
                await completeDailyLoginQuest(); // Fungsi login harian yang efisien dipanggil
                
                renderAll();
                setupRealtimeListeners();
            } catch (error) { console.error("Error loading data:", error); showError("Gagal memuat data."); loadingSpinner.style.display = 'none'; }
        }

        function setupRealtimeListeners() {
            if (!userId) return;
            console.log("Setting up real-time listeners.");
            
            const profileListener = onSnapshot(doc(db, `users/${userId}/profile/main`), (snap) => {
                if (snap.exists()) {
                    userProfile = snap.data();
                    if(isInitialLoadComplete) { 
                        updateUserProfileUI(); 
                        renderQuests(); 
                        if (!inventoryModal.classList.contains('hidden')) {
                            renderInventory();
                        }
                    }
                }
            });

            const transactionListener = onSnapshot(collection(db, `users/${userId}/transactions`), (snap) => {
                allTransactions = snap.docs.map(d => {
                    const data = d.data();
                    // Konversi Firestore Timestamp ke Javascript Date object di sini juga
                    const date = data.date && data.date.toDate ? data.date.toDate() : new Date();
                    return { id: d.id, ...data, date: date };
                });
                if(isInitialLoadComplete) {
                    renderAll();
                    checkAndCompleteQuests();
                }
            });

            const categoryListener = onSnapshot(collection(db, `users/${userId}/categories`), (snap) => {
                categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(isInitialLoadComplete) {
                    buildCategoryMap();
                    renderAll(); 
                }
            });

            const incomeCategoryListener = onSnapshot(collection(db, `users/${userId}/income_categories`), (snap) => {
                incomeCategories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(isInitialLoadComplete) {
                    buildCategoryMap();
                    renderAll();
                }
            });

            const goalsListener = onSnapshot(collection(db, `users/${userId}/goals`), (snap) => {
                financialGoals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(isInitialLoadComplete) renderGoals();
            });
            const debtsListener = onSnapshot(collection(db, `users/${userId}/debts`), (snap) => {
                debts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(isInitialLoadComplete) renderDebts();
            });
            const investmentsListener = onSnapshot(collection(db, `users/${userId}/investments`), (snap) => {
                investments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(isInitialLoadComplete) {
                    renderInvestments();
                    renderDashboard();
                }
            });

            listeners.push(profileListener, transactionListener, categoryListener, incomeCategoryListener, goalsListener, debtsListener, investmentsListener);
        }

        function clearDataAndUI() {
            allTransactions = []; categories = []; incomeCategories = [];
            financialGoals = []; debts = []; investments = [];
            categoryMap = {};
            userProfile = { level: 1, xp: 0, completedQuests: {}, failedQuests: {}, inventory: {}, activeBoosts: {}, lastPenaltyCheck: null, hasReadGuide: false, hasReadDashboardGuide: false, questRewards: {} };
            listeners.forEach(unsub => unsub());
            listeners = [];
            isInitialLoadComplete = false;
            appContent.style.display = 'none';
            loginScreen.style.display = 'flex';
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                defineQuests();
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.addEventListener('online', () => { offlineIndicator.style.display = 'none'; enableNetwork(db); });
                window.addEventListener('offline', () => { offlineIndicator.style.display = 'block'; });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userProfileDisplay.innerHTML = `<img src="${user.photoURL || 'https://placehold.co/40x40/334155/F8FAFC?text=?'}" alt="Foto Profil Pengguna" class="w-10 h-10 rounded-full"><span class="font-semibold">${user.displayName || 'Pengguna'}</span>`;
                        loginScreen.style.display = 'none';
                        appContent.style.display = 'block';
                        setTimeout(async () => {
                            await initializeAndLoadData();
                            loadingSpinner.style.display = 'none';
                        }, 500);
                    } else {
                        userId = null;
                        clearDataAndUI();
                        loadingSpinner.style.display = 'none';
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            } catch (e) { console.error("Firebase Init Error:", e); loadingSpinner.style.display = 'none'; showError("Gagal menginisialisasi aplikasi."); }
        });
        
        ['filter-text', 'category-search', 'income-category-search', 'goal-search', 'debt-search', 'investment-search'].forEach(id => {
            el(id).addEventListener('input', () => {
                if (id === 'filter-text') { selectedTransactions.clear(); renderTransactions(); } 
                else if (id === 'category-search') { selectedCategories.clear(); renderCategories(); } 
                else if (id === 'income-category-search') { selectedIncomeCategories.clear(); renderIncomeCategories(); }
                else if (id === 'goal-search') { selectedGoals.clear(); renderGoals(); }
                else if (id === 'debt-search') { selectedDebts.clear(); renderDebts(); }
                else if (id === 'investment-search') { selectedInvestments.clear(); renderInvestments(); }
                updateActionButtonsState();
            });
        });
        
        sortBtn.addEventListener('click', () => { sortDirection = sortDirection === 'desc' ? 'asc' : 'desc'; renderTransactions(); });
        inventoryBtn.addEventListener('click', () => { renderInventory(); openModal(inventoryModal); });
        gameGuideBtn.addEventListener('click', () => openModal(gameGuideModal));
        dashboardGuideBtn.addEventListener('click', () => openModal(dashboardGuideModal));

        filterBtn.addEventListener('click', () => {
            selectedTransactions.clear();
            renderTransactions();

            filterModal.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Filter Transaksi</h3>
                <select id="filter-type" class="input-field mb-4"><option value="">Semua Tipe</option><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option></select>
                <select id="filter-category" class="input-field"></select>
                <div class="mt-6 flex justify-end gap-3"><button id="cancel-filter-btn" class="btn bg-slate-600">Batal</button><button id="apply-filter-btn" class="btn btn-secondary">Terapkan</button></div>`;
            const typeDropdown = el('filter-type'), catDropdown = el('filter-category');
            const updateCatOptions = () => {
                const type = typeDropdown.value;
                let opts = '<option value="">Semua Kategori</option>';
                if (type === 'income') opts += incomeCategories.filter(c=>!c.isArchived).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                else if (type === 'expense') opts += categories.filter(c=>!c.isArchived).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                else {
                    opts += '<optgroup label="Pemasukan">' + incomeCategories.filter(c=>!c.isArchived).map(c=>`<option value="${c.id}">${c.name}</option>`).join('') + '</optgroup>';
                    opts += '<optgroup label="Pengeluaran">' + categories.filter(c=>!c.isArchived).map(c=>`<option value="${c.id}">${c.name}</option>`).join('') + '</optgroup>';
                }
                catDropdown.innerHTML = opts;
            };
            typeDropdown.value = activeFilters.type;
            updateCatOptions();
            catDropdown.value = activeFilters.category;
            typeDropdown.addEventListener('change', updateCatOptions);
            openModal(filterModal, '#filter-type');
            el('apply-filter-btn').addEventListener('click', () => { activeFilters.type = typeDropdown.value; activeFilters.category = catDropdown.value; renderTransactions(); closeModal(filterModal); });
            el('cancel-filter-btn').addEventListener('click', () => closeModal(filterModal));
        });

        googleSignInBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()).catch(err => console.error(err)));
        signOutBtn.addEventListener('click', () => signOut(auth).catch(err => console.error(err)));
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAll(); });
        nextMonthBtn.addEventListener('click', () => { if (!nextMonthBtn.disabled) { currentDate.setMonth(currentDate.getMonth() + 1); renderAll(); } });
        todayBtn.addEventListener('click', () => { currentDate = new Date(); renderAll(); });

        el('export-btn').addEventListener('click', () => {
            // Fungsi format mata uang lokal (jika belum ada di scope ini)
            const formatCurrencyLocal = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);

            const wb = XLSX.utils.book_new();
            const monthStr = currentDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

            // --- 1. Lembar Ringkasan (Sudah Ada & Disempurnakan) ---
            const currentMonthTxs = getTransactionsForMonth(currentDate);
            const prevMonthDate = new Date(currentDate);
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const prevMonthTxs = getTransactionsForMonth(prevMonthDate);
            const incomeThisMonth = currentMonthTxs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expenseThisMonth = currentMonthTxs.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const investmentValue = investments.reduce((sum, asset) => sum + (asset.units * (asset.currentPrice || asset.avgPrice)), 0);
            const totalCashBalance = allTransactions.reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0);
            const netWorth = totalCashBalance + investmentValue;
            const incomePrevMonth = prevMonthTxs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const getChangeText = (current, previous) => {
                if (previous === 0) return current > 0 ? '(Baru)' : '(0%)';
                const percentChange = ((current - previous) / previous) * 100;
                return `(${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(0)}% vs Bulan Lalu)`;
            };
            const summaryData = [
                { A: 'Laporan Keuangan', B: monthStr },
                {},
                { A: 'Pemasukan Bulan Ini', B: incomeThisMonth, C: getChangeText(incomeThisMonth, incomePrevMonth) },
                { A: 'Pengeluaran Bulan Ini', B: expenseThisMonth },
                { A: 'Arus Kas Bulan Ini', B: incomeThisMonth - expenseThisMonth },
                { A: 'Saving Rate', B: incomeThisMonth > 0 ? `${(((incomeThisMonth - expenseThisMonth) / incomeThisMonth) * 100).toFixed(0)}%` : 'N/A' },
                {},
                { A: 'Total Nilai Investasi', B: investmentValue },
                { A: 'Total Kas & Bank', B: totalCashBalance },
                { A: 'Total Kekayaan Bersih', B: netWorth },
            ];
            const wsSummary = XLSX.utils.json_to_sheet(summaryData, { skipHeader: true });
            wsSummary['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 25 }];
            XLSX.utils.book_append_sheet(wb, wsSummary, "Ringkasan");

            // --- 2. & 3. Lembar Detail Transaksi (Sudah Ada) ---
            const incomeData = currentMonthTxs.filter(t => t.type === 'income').map(t => ({ Tanggal: new Date(t.date).toLocaleDateString('id-ID'), Deskripsi: t.description, Kategori: categoryMap[t.category] || 'Tanpa Kategori', Jumlah: t.amount }));
            const wsIncome = XLSX.utils.json_to_sheet(incomeData);
            wsIncome['!cols'] = [{ wch: 15 }, { wch: 40 }, { wch: 25 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, wsIncome, "Detail Pemasukan");

            const expenseData = currentMonthTxs.filter(t => t.type === 'expense').map(t => ({ Tanggal: new Date(t.date).toLocaleDateString('id-ID'), Deskripsi: t.description, Kategori: categoryMap[t.category] || 'Tanpa Kategori', Jumlah: t.amount, '% dari Total': expenseThisMonth > 0 ? `${((t.amount / expenseThisMonth) * 100).toFixed(2)}%` : '0.00%' }));
            const wsExpense = XLSX.utils.json_to_sheet(expenseData);
            wsExpense['!cols'] = [{ wch: 15 }, { wch: 40 }, { wch: 25 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsExpense, "Detail Pengeluaran");
            
            // --- 4. Lembar Rincian Kategori (Sudah Ada) ---
            const expenseByCategory = categories.filter(c => !c.isArchived).map(cat => {
                const total = currentMonthTxs.filter(t => t.category === cat.id && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                return { Kategori: cat.name, Anggaran: cat.budget, Total_Pengeluaran: total, Sisa_Anggaran: cat.budget - total, '%_dari_Total': expenseThisMonth > 0 ? `${((total / expenseThisMonth) * 100).toFixed(2)}%` : '0.00%' };
            }).filter(c => c.Total_Pengeluaran > 0 || c.Anggaran > 0).sort((a, b) => b.Total_Pengeluaran - a.Total_Pengeluaran);
            const wsCategory = XLSX.utils.json_to_sheet(expenseByCategory);
            wsCategory['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsCategory, "Rincian Kategori");

            // --- 5. Lembar Portofolio Investasi (BARU) ---
            const investmentData = investments.map(inv => {
                const currentValue = inv.units * (inv.currentPrice || inv.avgPrice);
                const purchaseValue = inv.units * inv.avgPrice;
                const profitLoss = currentValue - purchaseValue;
                const profitLossPercent = purchaseValue > 0 ? (profitLoss / purchaseValue) * 100 : 0;
                return {
                    'Aset': inv.name,
                    'Unit/Lembar': inv.units,
                    'Harga Beli Rata-rata': inv.avgPrice,
                    'Harga Kini': (inv.currentPrice || inv.avgPrice),
                    'Total Nilai Kini': currentValue,
                    'Profit/Loss (Rp)': profitLoss,
                    'Profit/Loss (%)': `${profitLossPercent.toFixed(2)}%`
                };
            });
            if (investmentData.length > 0) {
                const wsInvestments = XLSX.utils.json_to_sheet(investmentData);
                wsInvestments['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsInvestments, "Portofolio Investasi");
            }

            // --- 6. Lembar Utang & Piutang (BARU) ---
            const debtData = debts.map(d => {
                const isDebt = d.type === 'debt';
                return {
                    'Nama': d.person,
                    'Tipe': isDebt ? 'Utang Saya' : 'Piutang',
                    'Jumlah': d.amount,
                    'Status': d.isPaid ? 'Lunas' : 'Belum Lunas'
                };
            });
            if (debtData.length > 0) {
                const wsDebts = XLSX.utils.json_to_sheet(debtData);
                wsDebts['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsDebts, "Utang & Piutang");
            }
            
            // --- 7. Lembar Tujuan Keuangan (BARU) ---
            const goalData = financialGoals.map(g => {
                const progress = g.targetAmount > 0 ? (g.currentAmount / g.targetAmount) * 100 : 0;
                const isCompleted = g.isCompleted || progress >= 100;
                return {
                    'Nama Tujuan': g.name,
                    'Target': g.targetAmount,
                    'Terkumpul': g.currentAmount,
                    'Progres': `${progress.toFixed(2)}%`,
                    'Status': isCompleted ? 'Tercapai' : 'Belum Tercapai'
                };
            });
            if (goalData.length > 0) {
                const wsGoals = XLSX.utils.json_to_sheet(goalData);
                wsGoals['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsGoals, "Tujuan Keuangan");
            }

            // --- Finalisasi dan Unduh File ---
            XLSX.writeFile(wb, `Laporan Keuangan Lengkap ${monthStr}.xlsx`);
        });

        selectAllCategoriesCheckbox.addEventListener('change', (e) => {
            const searchTerm = el('category-search').value.toLowerCase();
            const filteredIds = categories.filter(cat => !cat.isArchived && cat.name.toLowerCase().includes(searchTerm)).map(cat => cat.id);
            filteredIds.forEach(id => e.target.checked ? selectedCategories.add(id) : selectedCategories.delete(id));
            renderCategories(); updateActionButtonsState();
        });
        selectAllTransactionsCheckbox.addEventListener('change', (e) => {
            const filteredIds = getFilteredTransactions().map(t => t.id);
            filteredIds.forEach(id => e.target.checked ? selectedTransactions.add(id) : selectedTransactions.delete(id));
            renderTransactions(); updateActionButtonsState();
        });
        selectAllIncomeCategoriesCheckbox.addEventListener('change', (e) => {
            const searchTerm = el('income-category-search').value.toLowerCase();
            const filteredIds = incomeCategories.filter(cat => !cat.isArchived && cat.name.toLowerCase().includes(searchTerm)).map(cat => cat.id);
            filteredIds.forEach(id => e.target.checked ? selectedIncomeCategories.add(id) : selectedIncomeCategories.delete(id));
            renderIncomeCategories(); updateActionButtonsState();
        });
        selectAllGoalsCheckbox.addEventListener('change', (e) => {
            const searchTerm = el('goal-search').value.toLowerCase();
            const filteredIds = financialGoals.filter(g => g.name.toLowerCase().includes(searchTerm)).map(g => g.id);
            filteredIds.forEach(id => e.target.checked ? selectedGoals.add(id) : selectedGoals.delete(id));
            renderGoals(); updateActionButtonsState();
        });
        selectAllDebtsCheckbox.addEventListener('change', (e) => {
            const searchTerm = el('debt-search').value.toLowerCase();
            const filteredIds = debts.filter(d => d.person.toLowerCase().includes(searchTerm)).map(d => d.id);
            filteredIds.forEach(id => e.target.checked ? selectedDebts.add(id) : selectedDebts.delete(id));
            renderDebts(); updateActionButtonsState();
        });
        selectAllInvestmentsCheckbox.addEventListener('change', (e) => {
            const searchTerm = el('investment-search').value.toLowerCase();
            const filteredIds = investments.filter(i => i.name.toLowerCase().includes(searchTerm)).map(i => i.id);
            filteredIds.forEach(id => e.target.checked ? selectedInvestments.add(id) : selectedInvestments.delete(id));
            renderInvestments(); updateActionButtonsState();
        });

        // --- NEW FEATURE IMPLEMENTATION ---

        function renderGoals() {
            const listEl = el('goal-list');
            const searchTerm = el('goal-search').value.toLowerCase();
            const filteredGoals = financialGoals.filter(g => g.name.toLowerCase().includes(searchTerm));
            
            selectAllGoalsCheckbox.checked = filteredGoals.length > 0 && filteredGoals.every(g => selectedGoals.has(g.id));

            if (filteredGoals.length === 0) {
                listEl.innerHTML = `<p class="text-slate-500 text-center py-4">Tidak ada tujuan keuangan yang cocok.</p>`;
                return;
            }
            listEl.innerHTML = filteredGoals.map(goal => {
                const progress = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
                const isCompleted = goal.isCompleted || progress >= 100;
                const isSelected = selectedGoals.has(goal.id);
                const progressColor = isCompleted ? 'bg-green-500' : 'bg-cyan-500';
                return `
                <div class="bg-slate-700/50 p-4 rounded-lg flex items-center gap-4 ${isCompleted ? 'opacity-70' : ''}">
                    <input type="checkbox" data-id="${goal.id}" class="goal-checkbox custom-checkbox rounded" ${isSelected ? 'checked' : ''}>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-lg font-bold text-slate-200">${goal.name} ${isCompleted ? '<span class="text-green-400 text-sm">(Tercapai!)</span>' : ''}</h4>
                                <p class="text-sm text-slate-300">${formatCurrency(goal.currentAmount)} / ${formatCurrency(goal.targetAmount)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined action-icon" data-action="edit-goal" data-id="${goal.id}" aria-label="Edit Tujuan">edit</span>
                            </div>
                        </div>
                        <div class="w-full bg-slate-600 rounded-full h-2.5 mt-2">
                            <div class="${progressColor} h-2.5 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        ${!isCompleted ? `<button data-action="add-funds-goal" data-id="${goal.id}" class="btn btn-secondary text-xs py-1 px-3 mt-3 w-full sm:w-auto">Tambah Dana</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        async function checkGoalCompletion(goalId) {
            const goalRef = doc(db, `users/${userId}/goals/${goalId}`);
            const goalSnap = await getDoc(goalRef);
            if (!goalSnap.exists()) return;

            const goal = { id: goalSnap.id, ...goalSnap.data() };
            if (goal.isCompleted || goal.currentAmount < goal.targetAmount) return;

            await updateDoc(goalRef, { isCompleted: true });

            let xpReward = 0;
            let cardsToAward = 0;
            if (goal.targetAmount > 10000000) { xpReward = 1500; cardsToAward = 2; } 
            else if (goal.targetAmount > 1000000) { xpReward = 500; cardsToAward = 1; } 
            else { xpReward = 100; }
            
            const updates = { xp: increment(xpReward) };
            const cardIds = [];
            for (let i = 0; i < cardsToAward; i++) {
                const cardId = getRandomCard();
                updates[`inventory.${cardId}`] = increment(1);
                cardIds.push(CARD_TYPES[cardId].name);
            }

            await updateDoc(doc(db, `users/${userId}/profile/main`), updates);

            let rewardMessage = `Anda mendapatkan <strong>+${xpReward} XP</strong>`;
            if (cardIds.length > 0) rewardMessage += ` dan kartu: <strong>${cardIds.join(', ')}</strong>`;
            showNotificationModal('Tujuan Tercapai!', 'emoji_events', `Selamat! Anda telah mencapai tujuan "${goal.name}". ${rewardMessage}!`, 'amber');
        }

        function renderDebts() {
            const listEl = el('debt-list');
            const searchTerm = el('debt-search').value.toLowerCase();
            const filteredDebts = debts.filter(d => d.person.toLowerCase().includes(searchTerm));

            selectAllDebtsCheckbox.checked = filteredDebts.length > 0 && filteredDebts.every(d => selectedDebts.has(d.id));

            if (filteredDebts.length === 0) {
                listEl.innerHTML = `<p class="text-slate-500 text-center py-4">Tidak ada catatan utang/piutang yang cocok.</p>`;
                return;
            }
            listEl.innerHTML = filteredDebts.map(d => {
                const isDebt = d.type === 'debt';
                const isSelected = selectedDebts.has(d.id);
                return `
                <div class="bg-slate-700/50 p-3 rounded-lg flex items-center justify-between gap-3 ${d.isPaid ? 'opacity-60' : ''}">
                     <input type="checkbox" data-id="${d.id}" class="debt-checkbox custom-checkbox rounded" ${isSelected ? 'checked' : ''}>
                    <div class="flex-grow">
                        <p class="font-semibold text-slate-200">${d.person}</p>
                        <p class="text-sm ${isDebt ? 'text-red-400' : 'text-green-400'}">${isDebt ? 'Utang Saya' : 'Piutang'}: ${formatCurrency(d.amount)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        ${d.isPaid ? '<span class="font-bold text-green-400 text-sm">LUNAS</span>' : `<button data-action="toggle-debt-paid" data-id="${d.id}" class="btn btn-secondary text-xs py-1 px-2">Tandai Lunas</button>`}
                    </div>
                </div>`;
            }).join('');
        }

        function renderInvestments() {
            const listEl = el('investment-list');
            const searchTerm = el('investment-search').value.toLowerCase();
            const filteredInvestments = investments.filter(i => i.name.toLowerCase().includes(searchTerm));

            selectAllInvestmentsCheckbox.checked = filteredInvestments.length > 0 && filteredInvestments.every(i => selectedInvestments.has(i.id));

            if (filteredInvestments.length === 0) {
                listEl.innerHTML = `<p class="text-slate-500 text-center py-4">Tidak ada aset investasi yang cocok.</p>`;
                return;
            }
            listEl.innerHTML = filteredInvestments.map(inv => {
                const currentValue = inv.units * (inv.currentPrice || inv.avgPrice);
                const purchaseValue = inv.units * inv.avgPrice;
                const profitLoss = currentValue - purchaseValue;
                const profitLossPercent = purchaseValue > 0 ? (profitLoss / purchaseValue) * 100 : 0;
                const profitColor = profitLoss >= 0 ? 'text-green-400' : 'text-red-400';
                const isSelected = selectedInvestments.has(inv.id);

                return `
                <div class="bg-slate-700/50 p-4 rounded-lg flex items-center gap-3">
                    <input type="checkbox" data-id="${inv.id}" class="investment-checkbox custom-checkbox rounded self-start mt-1" ${isSelected ? 'checked' : ''}>
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-bold text-slate-200">${inv.name}</h4>
                            <span class="material-symbols-outlined action-icon" data-action="edit-investment" data-id="${inv.id}" aria-label="Edit Aset">edit</span>
                        </div>

                        <div class="flex justify-between items-end mt-2">
                            <div>
                                <p class="text-xs text-slate-400">Total Nilai Kini</p>
                                <p class="text-xl font-bold text-slate-100">${formatCurrency(currentValue)}</p>
                            </div>
                            <div class="text-right ${profitColor}">
                                <p class="font-semibold">${formatCurrency(profitLoss)}</p>
                                <p class="text-xs">(${profitLossPercent.toFixed(2)}%)</p>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-slate-700/50">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                <div>
                                    <p class="text-slate-400">Unit</p>
                                    <p class="font-mono">${inv.units}</p>
                                </div>
                                <div>
                                    <p class="text-slate-400">Harga Beli (rata-rata)</p>
                                    <p>${formatCurrency(inv.avgPrice)}</p>
                                </div>
                                <div class="mt-1">
                                    <p class="text-slate-400">Harga Kini (per unit)</p>
                                    <p>${formatCurrency(inv.currentPrice || inv.avgPrice)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTopSpendingCategories() {
            const listEl = el('top-spending-list');
            const transactions = getTransactionsForMonth(currentDate);
            const expenses = transactions.filter(t => t.type === 'expense');
            const spendingByCategory = expenses.reduce((acc, t) => {
                const catId = t.category || 'uncategorized';
                acc[catId] = (acc[catId] || 0) + t.amount;
                return acc;
            }, {});

            const sortedSpending = Object.entries(spendingByCategory)
                .map(([categoryId, total]) => ({
                    name: categoryMap[categoryId] || 'Tanpa Kategori',
                    total: total
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);

            if (sortedSpending.length === 0) {
                listEl.innerHTML = `<p class="text-slate-500 text-center py-4">Belum ada pengeluaran bulan ini.</p>`;
                return;
            }

            const maxSpent = sortedSpending[0].total;
            listEl.innerHTML = sortedSpending.map(item => {
                const progress = maxSpent > 0 ? (item.total / maxSpent) * 100 : 0;
                return `
                <div>
                    <div class="flex justify-between items-center text-sm mb-1">
                        <span class="font-semibold text-slate-300">${item.name}</span>
                        <span>${formatCurrency(item.total)}</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2">
                        <div class="bg-red-500 h-2 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- Event Listeners for Forms ---
        el('goal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = el('goal-name').value;
            const target = Number(el('goal-target').value);
            const date = el('goal-date').value;
            if (!name || !target || !date) return showError('Semua field tujuan harus diisi.');
            
            const button = e.target.querySelector('button[type="submit"]');
            setButtonLoading(button, true);
            try {
                await addDoc(collection(db, `users/${userId}/goals`), {
                    name: toTitleCase(name),
                    targetAmount: target,
                    currentAmount: 0,
                    targetDate: date,
                    isCompleted: false
                });
                e.target.reset();
            } catch (err) { showError('Gagal menambah tujuan.'); console.error(err); }
            finally { setButtonLoading(button, false); }
        });

        el('debt-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const person = el('debt-person').value;
            const amount = Number(el('debt-amount').value);
            const type = el('debt-type').value;
            if (!person || !amount) return showError('Nama dan jumlah harus diisi.');

            const button = e.target.querySelector('button[type="submit"]');
            setButtonLoading(button, true);
            try {
                await addDoc(collection(db, `users/${userId}/debts`), {
                    person: toTitleCase(person),
                    amount: amount,
                    type: type,
                    isPaid: false
                });
                e.target.reset();
            } catch (err) { showError('Gagal menambah catatan utang.'); console.error(err); }
            finally { setButtonLoading(button, false); }
        });

        el('investment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = el('investment-name').value;
            const units = Number(el('investment-units').value);
            const avgPrice = Number(el('investment-avg-price').value);
            if (!name || !units || !avgPrice) return showError('Semua field investasi harus diisi.');

            const button = e.target.querySelector('button[type="submit"]');
            setButtonLoading(button, true);
            try {
                await addDoc(collection(db, `users/${userId}/investments`), {
                    name: toTitleCase(name),
                    units: units,
                    avgPrice: avgPrice,
                    currentPrice: avgPrice // Default current price to average price
                });
                e.target.reset();
            } catch (err) { showError('Gagal menambah aset investasi.'); console.error(err); }
            finally { setButtonLoading(button, false); }
        });

        // --- TAMBAHKAN FUNGSI BARU INI ---
        function formatCompactCurrency(value) {
            if (value === null || value === undefined) return 'Rp 0';
            
            const absValue = Math.abs(value);
            let a, b;

            if (absValue >= 1e12) {
                a = value / 1e12;
                b = ' T'; // Triliun
            } else if (absValue >= 1e9) {
                a = value / 1e9;
                b = ' M'; // Miliar
            } else if (absValue >= 1e6) {
                a = value / 1e6;
                b = ' Jt'; // Juta
            } else {
                // Untuk angka di bawah 1 Juta, gunakan format biasa
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
            }

            // Format angka yang disingkat dengan maksimal 1 angka desimal
            const formattedA = new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 1
            }).format(a);

            return `Rp ${formattedA}${b}`;
        }
    </script>
</body>
</html>
